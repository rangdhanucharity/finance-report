<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Rangdhanu Charity Fund Tracker</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 12px;
            }
            
            .header {
                padding: 20px 15px !important;
            }
            
            .header h1 {
                font-size: 1.8em !important;
            }
            
            .admin-controls {
                position: static !important;
                margin-top: 15px;
                justify-content: center;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                padding: 12px !important;
            }
            
            .tab-content {
                padding: 15px !important;
            }
            
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
                gap: 10px !important;
            }
            
            .summary-card .value {
                font-size: 1.5em !important;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 600px;
            }
            
            .export-options {
                flex-direction: column;
            }
            
            .member-list {
                grid-template-columns: 1fr !important;
            }
            
            .modal-content {
                min-width: 90% !important;
                max-width: 95% !important;
                padding: 20px !important;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .legend {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em !important;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr !important;
            }
            
            .admin-btn {
                padding: 6px 10px !important;
                font-size: 0.8em !important;
            }
        }

        /* Desktop Optimizations */
        @media (min-width: 1200px) {
            .container {
                margin: 20px auto;
            }
            
            .tab-content {
                padding: 40px !important;
            }
        }

        /* Existing Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .admin-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .admin-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .admin-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .admin-btn.disabled:hover {
            background: rgba(255,255,255,0.2);
            transform: none;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 1em;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        input[type="number"], input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .cell-white { background: white; }
        .cell-yellow { background: #fff3cd; }
        .cell-red { background: #f8d7da; }
        .cell-green { background: #d4edda; }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        canvas {
            max-width: 100%;
        }

        .member-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .member-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .member-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .member-item.paid {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .member-item.due {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .add-member-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }

        .add-member-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .add-member-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .add-member-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-width: 400px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            opacity: 0.5;
            transform: none;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8em;
        }

        .delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .edit-btn {
            background: #ffc107;
            color: black;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 0.8em;
        }

        .edit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .month-header {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .login-modal {
            display: flex;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-logged-in {
            background: #28a745;
            color: white;
        }

        .status-logged-out {
            background: #dc3545;
            color: white;
        }

        .year-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .year-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-actions {
            display: flex;
            gap: 5px;
        }

        .toggle-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .collapsible {
            display: block;
        }

        .collapsible.collapsed {
            display: none;
        }

        .admin-contacts {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .admin-contact-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .taka-symbol {
            font-family: Arial, sans-serif;
            font-weight: bold;
        }

        .clickable-header {
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
            border-radius: 5px;
        }

        .clickable-header:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .manage-years-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .manage-years-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .sync-success {
            background: #28a745;
            color: white;
        }

        .sync-error {
            background: #dc3545;
            color: white;
        }

        .sync-pending {
            background: #ffc107;
            color: black;
        }

        .finance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .finance-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .finance-card.income {
            border-left-color: #28a745;
        }

        .finance-card.expense {
            border-left-color: #dc3545;
        }

        .finance-card.balance {
            border-left-color: #17a2b8;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #6c757d;
            font-size: 0.8em;
        }

        .log-admin {
            font-weight: bold;
            color: #667eea;
        }

        .log-action {
            font-weight: bold;
        }

        .log-details {
            margin-top: 5px;
            padding-left: 15px;
            color: #495057;
        }
        
        /* Hide admin controls when not logged in */
        .admin-only {
            display: none;
        }
        
        .admin-logged-in .admin-only {
            display: inline-flex;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div id="loadingText">Loading...</div>
        </div>
    </div>

    <div class="sync-status" id="syncStatus" style="display: none;"></div>

    <div class="container">
        <div class="header">
            <h1>Rangdhanu Charity Fund</h1>
            <p id="dateRange">Loading...</p>
            <div class="admin-controls">
                <span id="loginStatus" class="status-badge status-logged-out">Logged Out</span>
                <button class="admin-btn" onclick="showLoginModal()" id="loginBtn">üîê Admin Login</button>
                <button class="admin-btn" onclick="showExportModal()">üì§ Export Data</button>
                <button class="admin-btn admin-only" id="manageBtn" onclick="showManageModal()">‚öôÔ∏è Manage</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('collection')">üíµ Collection Sheet</button>
            <button class="tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reports</button>
            <button class="tab" onclick="switchTab('finance')">üí∞ Finance</button>
            <button class="tab" onclick="switchTab('logs')">üìã Activity Logs</button>
        </div>

        <!-- Collection Tab -->
        <div id="collection" class="tab-content active">
            <div class="export-options">
                <button class="add-member-btn admin-only" id="addMemberBtn" onclick="showAddMemberModal()">+ Add New Member</button>
                <button class="add-member-btn admin-only" id="addYearBtn" onclick="showAddYearModal()">+ Add New Year</button>
                <button class="add-member-btn admin-only" id="manageMembersBtn" onclick="showManageMembersModal()">üë• Manage Members</button>
                <button class="add-member-btn admin-only" id="manageYearsBtn" onclick="showManageYearsModal()">üìÖ Manage Years</button>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color cell-white"></div>
                    <span>Future Month</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color cell-yellow"></div>
                    <span>Current Month (Before 10th)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color cell-red"></div>
                    <span>Overdue (After 10th)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color cell-green"></div>
                    <span>Paid</span>
                </div>
            </div>

            <div id="yearsContainer">
                <!-- Years will be dynamically added here -->
            </div>

            <h3 style="margin: 30px 0 15px 0;">One-Time Public Donations</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Donor Name</th>
                            <th>Amount (‡ß≥)</th>
                            <th>Note</th>
                            <th class="admin-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="donationsBody"></tbody>
                </table>
            </div>
            <button class="add-member-btn admin-only" id="addDonationBtn" onclick="showAddDonationModal()">+ Add Donation</button>
            <div style="margin-top: 15px; font-weight: bold;">
                Total Public Donations: <span class="taka-symbol">‡ß≥</span><span id="totalDonations">0</span>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Total Collected</h3>
                    <div class="value" id="totalCollected">‡ß≥0</div>
                </div>
                <div class="summary-card">
                    <h3>Current Month Collection</h3>
                    <div class="value" id="currentMonthCollection">‡ß≥0</div>
                </div>
                <div class="summary-card">
                    <h3>Paid Members</h3>
                    <div class="value" id="paidCount">0</div>
                </div>
                <div class="summary-card">
                    <h3>Due Members</h3>
                    <div class="value" id="dueCount">0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">Monthly Collection Trend</h3>
                <canvas id="monthlyChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">Top Contributors</h3>
                <canvas id="contributorsChart"></canvas>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="summary-grid">
                <div class="summary-card clickable-header" onclick="toggleMemberList('paid')">
                    <h3>‚úÖ Paid Members (Current Month)</h3>
                    <div class="value" id="paidCountReport">0</div>
                    <small>Click to view/hide list</small>
                </div>
                <div class="summary-card clickable-header" onclick="toggleMemberList('due')">
                    <h3>‚ùå Due Members (Current Month)</h3>
                    <div class="value" id="dueCountReport">0</div>
                    <small>Click to view/hide list</small>
                </div>
            </div>

            <div id="paidListSection">
                <h3 style="margin: 20px 0 15px 0;">Paid Members List</h3>
                <div class="member-list" id="paidList"></div>
            </div>

            <div id="dueListSection">
                <h3 style="margin: 20px 0 15px 0;">Due Members List</h3>
                <div class="member-list" id="dueList"></div>
            </div>

            <h3 style="margin: 30px 0 20px 0;">Member Contribution Summary</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Member Name</th>
                            <th>Total Contribution</th>
                            <th>Months Paid</th>
                            <th>Months Due</th>
                            <th class="admin-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contributionSummary"></tbody>
                </table>
            </div>
        </div>

        <!-- Finance Tab -->
        <div id="finance" class="tab-content">
            <div class="finance-summary">
                <div class="finance-card income">
                    <h3>Total Collection</h3>
                    <div class="value" id="totalIncome">‡ß≥0</div>
                </div>
                <div class="finance-card expense">
                    <h3>Total Expenditure</h3>
                    <div class="value" id="totalExpenditure">‡ß≥0</div>
                </div>
                <div class="finance-card balance">
                    <h3>Current Balance</h3>
                    <div class="value" id="currentBalance">‡ß≥0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">Collection vs Expenditure</h3>
                <canvas id="financeChart"></canvas>
            </div>

            <div class="export-options">
                <button class="add-member-btn admin-only" id="addExpenseBtn" onclick="showAddExpenseModal()">+ Add Expense</button>
            </div>

            <h3 style="margin: 30px 0 15px 0;">Expenditure Records</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount (‡ß≥)</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th class="admin-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Activity Logs Tab -->
        <div id="logs" class="tab-content">
            <h3 style="margin-bottom: 20px;">Admin Activity Logs</h3>
            <div class="table-container">
                <div id="activityLogs">
                    <!-- Activity logs will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h3>üîê Admin Login - Rangdhanu Charity Fund</h3>
            <div class="form-group">
                <label for="adminName">Admin Name:</label>
                <input type="text" id="adminName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideLoginModal()">Cancel</button>
                <button class="btn btn-primary" onclick="login()">Login</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Expense</h3>
            <div class="form-group">
                <label for="expenseDate">Date:</label>
                <input type="date" id="expenseDate" value="">
            </div>
            <div class="form-group">
                <label for="expenseAmount">Amount (‡ß≥):</label>
                <input type="number" id="expenseAmount" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label for="expenseCategory">Category:</label>
                <select id="expenseCategory">
                    <option value="Operational">Operational</option>
                    <option value="Event">Event</option>
                    <option value="Administrative">Administrative</option>
                    <option value="Charity">Charity</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expenseDescription">Description:</label>
                <textarea id="expenseDescription" placeholder="Enter expense description"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddExpenseModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddExpense()">Add Expense</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h3>üì§ Export Data - Rangdhanu Charity Fund</h3>
            <div class="form-group">
                <label>Export Format:</label>
                <select id="exportFormat">
                    <option value="excel">Excel File (.xlsx)</option>
                    <option value="pdf">PDF Document</option>
                </select>
            </div>
            <div class="form-group">
                <label>Data to Export:</label>
                <select id="exportData">
                    <option value="all">Full Comprehensive Report (All Data)</option>
                    <option value="financial">Financial Summary (Collection/Expense)</option>
                    <option value="members">Detailed Member Payment Sheet</option>
                    <option value="donations">Public Donations Only</option>
                    <option value="expenses">Expenditure Records Only</option>
                    <option value="logs">Activity Logs</option>
                </select>
            </div>
            <div class="form-group" id="yearSelectionGroup" style="display: none;">
                <label>Select Year (for Member Sheet):</label>
                <select id="exportYearSelect"></select>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideExportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="exportData()">Export</button>
            </div>
        </div>
    </div>

    <!-- Manage Modal -->
    <div id="manageModal" class="modal">
        <div class="modal-content">
            <h3>‚öôÔ∏è System Management</h3>
            <div class="form-group">
                <button class="btn btn-primary" onclick="showBackupModal()" style="width: 100%; margin-bottom: 10px;">üíæ Backup Data</button>
                <button class="btn btn-primary" onclick="showRestoreModal()" style="width: 100%; margin-bottom: 10px;">üîÑ Restore Data</button>
                <button class="btn btn-secondary" onclick="logout()" style="width: 100%;">üö™ Logout</button>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideManageModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Member</h3>
            <div class="form-group">
                <label for="newMemberName">Member Name:</label>
                <input type="text" id="newMemberName" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label for="newMemberPhone">Phone Number:</label>
                <input type="text" id="newMemberPhone" placeholder="Optional">
            </div>
            <div class="form-group">
                <label for="newMemberEmail">Email Address:</label>
                <input type="email" id="newMemberEmail" placeholder="Optional">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddMemberModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddMember()">Add Member</button>
            </div>
        </div>
    </div>

    <!-- Add Donation Modal -->
    <div id="donationModal" class="modal">
        <div class="modal-content">
            <h3>+ Record New Public Donation</h3>
            <div class="form-group">
                <label for="donationDate">Date:</label>
                <input type="date" id="donationDate">
            </div>
            <div class="form-group">
                <label for="donorName">Donor Name:</label>
                <input type="text" id="donorName" placeholder="Enter donor name">
            </div>
            <div class="form-group">
                <label for="donationAmount">Amount (‡ß≥):</label>
                <input type="number" id="donationAmount" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label for="donationNote">Note (optional):</label>
                <textarea id="donationNote" placeholder="e.g. For food drive, Anonymous"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideDonationModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddDonation()">Record Donation</button>
            </div>
        </div>
    </div>

    <!-- Manage Members Modal -->
    <div id="manageMembersModal" class="modal">
        <div class="modal-content">
            <h3>üë• Manage Members</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Member Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Join Date</th>
                            <th>Total Paid</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="manageMembersBody"></tbody>
                </table>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideManageMembersModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Year Modal -->
    <div id="addYearModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Year</h3>
            <div class="form-group">
                <label for="newYear">Select Year:</label>
                <input type="number" id="newYear" min="2024" max="2030" value="2027">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddYearModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddYear()">Add Year</button>
            </div>
        </div>
    </div>

    <!-- Manage Years Modal -->
    <div id="manageYearsModal" class="modal">
        <div class="modal-content">
            <h3>üìÖ Manage Years</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Months</th>
                            <th>Total Collection</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="manageYearsBody"></tbody>
                </table>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideManageYearsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <h3>üíæ Backup Data</h3>
            <div class="form-group">
                <p>Click the button below to create a backup of all data. This will save a copy to Firebase.</p>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideBackupModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createBackup()">Create Backup</button>
            </div>
        </div>
    </div>

    <!-- Restore Modal -->
    <div id="restoreModal" class="modal">
        <div class="modal-content">
            <h3>üîÑ Restore Data</h3>
            <div class="form-group">
                <p>Select a backup to restore from:</p>
                <select id="backupSelect">
                    <option value="">Loading backups...</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideRestoreModal()">Cancel</button>
                <button class="btn btn-primary" onclick="restoreBackup()">Restore</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <h3 id="dialogTitle">Dialog</h3>
            <p id="dialogMessage" style="margin-bottom: 20px;"></p>
            <div class="form-actions">
                <button class="btn btn-secondary" id="dialogCancelBtn" style="display: none;">Cancel</button>
                <button class="btn btn-primary" id="dialogConfirmBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDChxV-zUTEMK_Oe1xJVn123c8l7fonhDk",
            authDomain: "rangdhanu-1bdec.firebaseapp.com",
            projectId: "rangdhanu-1bdec",
            storageBucket: "rangdhanu-1bdec.firebasestorage.app",
            messagingSenderId: "842682768144",
            appId: "1:842682768144:web:ba7cdfbab05e0b7bd52395",
            measurementId: "G-P3YGK1TF48"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Enhanced data structure with proper serialization
        let appData = {
            organization: "Rangdhanu Charity Fund",
            appVersion: "4.3",
            years: {
                "2025": {
                    months: ['Nov 2025', 'Dec 2025'],
                    monthDates: [
                        '2025-11-01T00:00:00.000Z', 
                        '2025-12-01T00:00:00.000Z'
                    ]
                },
                "2026": {
                    months: ['Jan 2026', 'Feb 2026', 'Mar 2026', 'Apr 2026', 'May 2026', 'Jun 2026', 
                            'Jul 2026', 'Aug 2026', 'Sep 2026', 'Oct 2026', 'Nov 2026', 'Dec 2026'],
                    monthDates: [
                        '2026-01-01T00:00:00.000Z', 
                        '2026-02-01T00:00:00.000Z', 
                        '2026-03-01T00:00:00.000Z',
                        '2026-04-01T00:00:00.000Z', 
                        '2026-05-01T00:00:00.000Z', 
                        '2026-06-01T00:00:00.000Z',
                        '2026-07-01T00:00:00.000Z', 
                        '2026-08-01T00:00:00.000Z', 
                        '2026-09-01T00:00:00.000Z',
                        '2026-10-01T00:00:00.000Z', 
                        '2026-11-01T00:00:00.000Z', 
                        '2026-12-01T00:00:00.000Z'
                    ]
                }
            },
            members: [
                { id: 1, name: 'Ahmed Rahman', phone: '+8801XXX', email: 'ahmed@example.com', joinDate: '2025-01-15' },
                { id: 2, name: 'Fatima Khan', phone: '+8801XXX', email: 'fatima@example.com', joinDate: '2025-01-15' },
                { id: 3, name: 'Mohammad Ali', phone: '+8801XXX', email: 'mohammad@example.com', joinDate: '2025-01-15' },
                { id: 4, name: 'Ayesha Begum', phone: '+8801XXX', email: 'ayesha@example.com', joinDate: '2025-01-15' },
                { id: 5, name: 'Ibrahim Hassan', phone: '+8801XXX', email: 'ibrahim@example.com', joinDate: '2025-01-15' }
            ],
            payments: {},
            donations: [],
            expenses: [],
            activityLogs: [],
            settings: {
                admins: {
                    "Ful Mia": "admin123",
                    "Shah Paran": "super123"
                },
                currentAdmin: null,
                isAuthenticated: false,
                adminContacts: [
                    { name: 'Admin 1', phone: '+8801712345678', email: 'admin1@rangdhanu.org' },
                    { name: 'Admin 2', phone: '+8801812345678', email: 'admin2@rangdhanu.org' }
                ]
            }
        };

        let monthlyChart, contributorsChart, financeChart;
        let isOnline = navigator.onLine;

        // ========== FIREBASE DATA MANAGEMENT ==========

        async function initializeFirebase() {
            showLoading('Connecting to database...');
            try {
                // Load settings first
                const settingsDoc = await db.collection('settings').doc('appSettings').get();
                if (settingsDoc.exists) {
                    const settingsData = settingsDoc.data();
                    appData.settings = { ...appData.settings, ...settingsData };
                } else {
                    // Initialize default settings if none exist
                    await db.collection('settings').doc('appSettings').set(appData.settings);
                }

                // Load all other data with better error handling
                await loadAllData();
                
                hideLoading();
                showSyncStatus('Connected to cloud database!', 'success');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                // Initialize with default data if Firebase fails
                await initializeWithDefaultData();
                hideLoading();
                showSyncStatus('Using offline mode', 'error');
            }
        }

        async function loadAllData() {
            try {
                console.log('Loading data from Firebase...');
                
                // Load years with default fallback
                const yearsSnapshot = await db.collection('years').get();
                if (!yearsSnapshot.empty) {
                    appData.years = {};
                    yearsSnapshot.forEach(doc => {
                        const yearData = doc.data();
                        // Ensure monthDates are properly converted from Firestore timestamps
                        if (yearData.monthDates && yearData.monthDates.length > 0) {
                            yearData.monthDates = yearData.monthDates.map(date => {
                                if (date && date.toDate) {
                                    return date.toDate().toISOString();
                                }
                                return date;
                            });
                        }
                        appData.years[doc.id] = yearData;
                    });
                } else {
                    console.log('No years found, using default years');
                    // Initialize default years if none exist
                    for (const [year, yearData] of Object.entries(appData.years)) {
                        await saveYear(year, yearData);
                    }
                }

                // Load members with default fallback
                const membersSnapshot = await db.collection('members').get();
                if (!membersSnapshot.empty) {
                    appData.members = [];
                    membersSnapshot.forEach(doc => {
                        appData.members.push({ id: parseInt(doc.id), ...doc.data() });
                    });
                    // Sort members by ID to maintain consistency
                    appData.members.sort((a, b) => a.id - b.id);
                } else {
                    console.log('No members found, using default members');
                    // Initialize default members if none exist
                    for (const member of appData.members) {
                        await saveMember(member);
                    }
                }

                // Load payments with proper structure initialization
                const paymentsSnapshot = await db.collection('payments').get();
                appData.payments = {};
                if (!paymentsSnapshot.empty) {
                    paymentsSnapshot.forEach(doc => {
                        const paymentData = doc.data();
                        // Convert any Firestore timestamps in payment data
                        Object.keys(paymentData).forEach(year => {
                            if (paymentData[year] && Array.isArray(paymentData[year])) {
                                paymentData[year] = paymentData[year].map(payment => {
                                    if (payment && typeof payment === 'object' && payment.toDate) {
                                        return payment.toDate().toISOString();
                                    }
                                    return payment;
                                });
                            }
                        });
                        appData.payments[doc.id] = paymentData;
                    });
                }

                // Initialize payments structure for all members
                initializePayments();

                // Load donations
                const donationsSnapshot = await db.collection('donations').get();
                appData.donations = [];
                if (!donationsSnapshot.empty) {
                    donationsSnapshot.forEach(doc => {
                        const donationData = doc.data();
                        // Ensure date is properly formatted
                        if (donationData.date && donationData.date.toDate) {
                            donationData.date = donationData.date.toDate().toISOString().split('T')[0];
                        }
                        appData.donations.push({ id: doc.id, ...donationData });
                    });
                    // Sort donations by date
                    appData.donations.sort((a, b) => new Date(b.date) - new Date(a.date));
                }

                // Load expenses
                const expensesSnapshot = await db.collection('expenses').get();
                appData.expenses = [];
                if (!expensesSnapshot.empty) {
                    expensesSnapshot.forEach(doc => {
                        const expenseData = doc.data();
                        // Ensure dates are properly formatted
                        if (expenseData.date && expenseData.date.toDate) {
                            expenseData.date = expenseData.date.toDate().toISOString().split('T')[0];
                        }
                        if (expenseData.addedOn && expenseData.addedOn.toDate) {
                            expenseData.addedOn = expenseData.addedOn.toDate().toISOString();
                        }
                        appData.expenses.push({ id: doc.id, ...expenseData });
                    });
                    // Sort expenses by date
                    appData.expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                }

                // Load activity logs
                const logsSnapshot = await db.collection('activityLogs')
                    .orderBy('timestamp', 'desc')
                    .limit(1000)
                    .get();
                appData.activityLogs = [];
                if (!logsSnapshot.empty) {
                    logsSnapshot.forEach(doc => {
                        const logData = doc.data();
                        // Ensure timestamp is properly formatted
                        if (logData.timestamp && logData.timestamp.toDate) {
                            logData.timestamp = logData.timestamp.toDate().toISOString();
                        }
                        appData.activityLogs.push(logData);
                    });
                }

                console.log('Data loaded successfully:', {
                    years: Object.keys(appData.years).length,
                    members: appData.members.length,
                    payments: Object.keys(appData.payments).length,
                    donations: appData.donations.length,
                    expenses: appData.expenses.length,
                    logs: appData.activityLogs.length
                });

            } catch (error) {
                console.error('Error loading data:', error);
                throw error;
            }
        }

        async function initializeWithDefaultData() {
            console.log('Initializing with default data...');
            
            // Ensure payments structure is initialized
            initializePayments();
            
            // Save default data to Firebase if online
            if (isOnline) {
                try {
                    // Save default settings
                    await db.collection('settings').doc('appSettings').set(appData.settings);
                    
                    // Save default years
                    for (const [year, yearData] of Object.entries(appData.years)) {
                        await saveYear(year, yearData);
                    }
                    
                    // Save default members
                    for (const member of appData.members) {
                        await saveMember(member);
                    }
                    
                    console.log('Default data saved to Firebase');
                } catch (error) {
                    console.error('Error saving default data:', error);
                }
            }
        }

        async function saveData() {
            if (!isOnline) {
                showSyncStatus('Offline - changes will sync when online', 'pending');
                return;
            }

            try {
                showSyncStatus('Saving to cloud...', 'pending');
                
                // Save settings
                await db.collection('settings').doc('appSettings').set(appData.settings, { merge: true });

                showSyncStatus('All changes saved to cloud!', 'success');
            } catch (error) {
                console.error('Error saving data:', error);
                showSyncStatus('Error saving to cloud', 'error');
            }
        }

        // Individual save functions for better performance
        async function saveMember(member) {
            if (!isOnline) return;
            try {
                await db.collection('members').doc(member.id.toString()).set(member, { merge: true });
            } catch (error) {
                console.error('Error saving member:', error);
            }
        }

        async function savePayment(memberId, year, payments) {
            if (!isOnline) return;
            try {
                await db.collection('payments').doc(memberId.toString()).set({
                    [year]: payments
                }, { merge: true });
            } catch (error) {
                console.error('Error saving payment:', error);
            }
        }

        async function saveDonation(donation) {
            if (!isOnline) return;
            try {
                const docRef = donation.id ? 
                    db.collection('donations').doc(donation.id) :
                    db.collection('donations').doc();
                
                await docRef.set(donation, { merge: true });
                return docRef.id;
            } catch (error) {
                console.error('Error saving donation:', error);
            }
        }

        async function saveExpense(expense) {
            if (!isOnline) return;
            try {
                const docRef = expense.id ? 
                    db.collection('expenses').doc(expense.id) :
                    db.collection('expenses').doc();
                
                await docRef.set(expense, { merge: true });
                return docRef.id;
            } catch (error) {
                console.error('Error saving expense:', error);
            }
        }

        async function saveYear(year, yearData) {
            if (!isOnline) return;
            try {
                await db.collection('years').doc(year).set(yearData, { merge: true });
            } catch (error) {
                console.error('Error saving year:', error);
            }
        }

        async function logActivity(action, details) {
            if (!appData.settings.isAuthenticated || !appData.settings.currentAdmin) return;
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                admin: appData.settings.currentAdmin,
                action: action,
                details: details
            };
            
            appData.activityLogs.unshift(logEntry);
            
            // Keep only last 1000 logs
            if (appData.activityLogs.length > 1000) {
                appData.activityLogs = appData.activityLogs.slice(0, 1000);
            }
            
            // Save to Firebase
            if (isOnline) {
                try {
                    await db.collection('activityLogs').add(logEntry);
                } catch (error) {
                    console.error('Error saving activity log:', error);
                }
            }
            
            if (document.getElementById('logs').classList.contains('active')) {
                renderActivityLogs();
            }
        }

        // ========== CUSTOM DIALOG MANAGEMENT ==========

        function hideCustomDialogModal() {
            document.getElementById('customDialogModal').style.display = 'none';
        }

        function showCustomAlert(message, title = 'Notification', type = 'primary') {
            const modal = document.getElementById('customDialogModal');
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogMessage').textContent = message;
            
            const confirmBtn = document.getElementById('dialogConfirmBtn');
            const cancelBtn = document.getElementById('dialogCancelBtn');

            confirmBtn.textContent = 'OK';
            confirmBtn.className = `btn btn-${type}`;
            confirmBtn.onclick = hideCustomDialogModal;

            cancelBtn.style.display = 'none';
            modal.style.display = 'flex';
        }

        function showCustomConfirm(message, title = 'Confirmation', type = 'danger', callback) {
            const modal = document.getElementById('customDialogModal');
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogMessage').textContent = message;
            
            const confirmBtn = document.getElementById('dialogConfirmBtn');
            const cancelBtn = document.getElementById('dialogCancelBtn');

            confirmBtn.textContent = 'Confirm';
            confirmBtn.className = `btn btn-${type}`;
            confirmBtn.onclick = () => {
                hideCustomDialogModal();
                callback(true);
            };

            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.onclick = () => {
                hideCustomDialogModal();
                callback(false);
            };
            cancelBtn.style.display = 'inline-flex';
            modal.style.display = 'flex';
        }

        // ========== NETWORK STATUS HANDLING ==========

        function handleOnline() {
            isOnline = true;
            showSyncStatus('Back online - syncing data...', 'pending');
            initializeFirebase(); // Re-sync data when back online
        }

        function handleOffline() {
            isOnline = false;
            showSyncStatus('You are offline - changes saved locally', 'error');
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status sync-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        function showLoading(message) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ========== AUTHENTICATION FUNCTIONS ==========

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('adminName').value = '';
            document.getElementById('adminPassword').value = '';
        }

        function login() {
            const adminName = document.getElementById('adminName').value.trim();
            const password = document.getElementById('adminPassword').value;
            
            if (!adminName) {
                showCustomAlert('‚ùå Please enter your name!', 'Login Error', 'warning');
                return;
            }
            
            if (appData.settings.admins[adminName] && password === appData.settings.admins[adminName]) {
                appData.settings.isAuthenticated = true;
                appData.settings.currentAdmin = adminName;
                hideLoginModal();
                updateLoginStatus();
                updateAdminControls();
                renderYears();
                
                logActivity('logged in', `Admin ${adminName} logged into the system`);
                
                showCustomAlert('‚úÖ Admin access granted!', 'Success', 'success');
            } else {
                showCustomAlert('‚ùå Invalid username or password!', 'Login Error', 'danger');
            }
        }

        function logout() {
            const adminName = appData.settings.currentAdmin;
            appData.settings.isAuthenticated = false;
            appData.settings.currentAdmin = null;
            updateLoginStatus();
            updateAdminControls();
            renderYears();
            hideManageModal();
            
            if (adminName) {
                logActivity('logged out', `Admin ${adminName} logged out of the system`);
            }
            
            showCustomAlert('‚úÖ Logged out successfully!', 'Success', 'success');
        }

        function updateLoginStatus() {
            const statusElement = document.getElementById('loginStatus');
            const loginBtn = document.getElementById('loginBtn');
            
            if (appData.settings.isAuthenticated) {
                statusElement.textContent = `Logged in as ${appData.settings.currentAdmin}`;
                statusElement.className = 'status-badge status-logged-in';
                loginBtn.textContent = 'üö™ Logout';
                loginBtn.onclick = logout;
                document.body.classList.add('admin-logged-in');
            } else {
                statusElement.textContent = 'Logged Out';
                statusElement.className = 'status-badge status-logged-out';
                loginBtn.textContent = 'üîê Admin Login';
                loginBtn.onclick = showLoginModal;
                document.body.classList.remove('admin-logged-in');
            }
        }

        function requireAuth() {
            if (!appData.settings.isAuthenticated) {
                showCustomAlert('üîê Admin authentication required!', 'Authorization Required', 'danger');
                showLoginModal();
                return false;
            }
            return true;
        }

        // ========== ADMIN CONTROLS MANAGEMENT ==========

        function updateAdminControls() {
            // Admin controls are now handled by CSS classes
            // The admin-only class is hidden by default and shown when logged in
        }

        // ========== TAB MANAGEMENT ==========

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'reports') updateReports();
            if (tabName === 'finance') updateFinance();
            if (tabName === 'logs') renderActivityLogs();
        }

        // ========== CORE APPLICATION FUNCTIONS ==========

        function initializePayments() {
            console.log('Initializing payments structure...');
            
            appData.members.forEach(member => {
                if (!appData.payments[member.id]) {
                    appData.payments[member.id] = {};
                }
                
                Object.keys(appData.years).forEach(year => {
                    if (!appData.payments[member.id][year]) {
                        appData.payments[member.id][year] = Array(appData.years[year].months.length).fill(null);
                    }
                });
            });
            
            console.log('Payments initialized for', appData.members.length, 'members across', Object.keys(appData.years).length, 'years');
        }

        // ========== YEAR MANAGEMENT ==========

        function renderYears() {
            const container = document.getElementById('yearsContainer');
            container.innerHTML = '';
            
            Object.keys(appData.years).sort().forEach(year => {
                const yearData = appData.years[year];
                const yearSection = document.createElement('div');
                yearSection.className = 'year-section';
                yearSection.innerHTML = `
                    <div class="year-header">
                        <div class="year-title">
                            ${year} - Rangdhanu Charity Fund
                            ${appData.settings.isAuthenticated ? 
                                `<button class="delete-btn admin-only" onclick="deleteYearConfirmation('${year}')">Delete Year</button>` : 
                                ''}
                        </div>
                        <div class="year-actions">
                            <button class="toggle-btn" onclick="toggleYear('${year}')">‚ñº</button>
                        </div>
                    </div>
                    <div id="year-${year}" class="collapsible">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr id="header-${year}"></tr>
                                </thead>
                                <tbody id="body-${year}"></tbody>
                                <tfoot>
                                    <tr id="total-${year}" style="font-weight: bold; background: #f8f9fa;"></tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(yearSection);
                renderYearTable(year);
            });
            
            updateDateRange();
        }

        function renderYearTable(year) {
            const headerRow = document.getElementById(`header-${year}`);
            const tableBody = document.getElementById(`body-${year}`);
            const totalRow = document.getElementById(`total-${year}`);
            const yearData = appData.years[year];

            headerRow.innerHTML = '<th>Member Name</th>';
            yearData.months.forEach((month, index) => {
                headerRow.innerHTML += `
                    <th>
                        <div class="month-header">
                            ${month}
                            ${appData.settings.isAuthenticated ? `<button class="delete-btn admin-only" onclick="deleteMonthConfirmation('${year}', ${index})">√ó</button>` : ''}
                        </div>
                    </th>`;
            });
            headerRow.innerHTML += '<th>Total</th>';

            tableBody.innerHTML = '';
            appData.members.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `<td><strong>${member.name}</strong></td>`;
                
                yearData.months.forEach((month, mIdx) => {
                    const payment = appData.payments[member.id]?.[year]?.[mIdx];
                    const cellClass = payment ? 'cell-green' : getCellClass(year, mIdx);
                    row.innerHTML += `
                        <td class="${cellClass}">
                            <input type="number" value="${payment || ''}" 
                                       onchange="updatePayment(${member.id}, '${year}', ${mIdx}, this.value)"
                                       placeholder="0" ${!appData.settings.isAuthenticated ? 'disabled' : ''}>
                        </td>`;
                });

                const total = (appData.payments[member.id]?.[year] || []).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
                row.innerHTML += `<td><strong><span class="taka-symbol">‡ß≥</span>${total.toFixed(2)}</strong></td>`;
                tableBody.appendChild(row);
            });

            totalRow.innerHTML = '<td>Monthly Total</td>';
            yearData.months.forEach((month, mIdx) => {
                const monthTotal = appData.members.reduce((sum, member) => 
                    sum + (parseFloat(appData.payments[member.id]?.[year]?.[mIdx]) || 0), 0);
                totalRow.innerHTML += `<td><span class="taka-symbol">‡ß≥</span>${monthTotal.toFixed(2)}</td>`;
            });

            const grandTotal = appData.members.reduce((sum, member) => 
                sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
            totalRow.innerHTML += `<td><span class="taka-symbol">‡ß≥</span>${grandTotal.toFixed(2)}</td>`;
        }

        function getCellClass(year, monthIndex) {
            const today = new Date();
            // Ensure monthDate is a Date object
            let monthDate;
            if (typeof appData.years[year].monthDates[monthIndex] === 'string') {
                monthDate = new Date(appData.years[year].monthDates[monthIndex]);
            } else if (appData.years[year].monthDates[monthIndex] && appData.years[year].monthDates[monthIndex].toDate) {
                monthDate = appData.years[year].monthDates[monthIndex].toDate();
            } else {
                monthDate = appData.years[year].monthDates[monthIndex];
            }
            
            const deadline = new Date(monthDate.getFullYear(), monthDate.getMonth(), 10);
            
            if (today < monthDate) return 'cell-white';
            if (today >= monthDate && today <= deadline) return 'cell-yellow';
            if (today > deadline) return 'cell-red';
            return 'cell-white';
        }

        function showAddYearModal() {
            if (!requireAuth()) return;
            document.getElementById('addYearModal').style.display = 'flex';
        }

        function hideAddYearModal() {
            document.getElementById('addYearModal').style.display = 'none';
        }

        async function confirmAddYear() {
            const year = document.getElementById('newYear').value;
            
            if (year && !appData.years[year]) {
                appData.years[year] = {
                    months: [],
                    monthDates: []
                };
                
                for (let month = 0; month < 12; month++) {
                    const date = new Date(year, month, 1);
                    const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    appData.years[year].months.push(monthName);
                    appData.years[year].monthDates.push(date.toISOString());
                }
                
                appData.members.forEach(member => {
                    if (!appData.payments[member.id]) {
                        appData.payments[member.id] = {};
                    }
                    appData.payments[member.id][year] = Array(12).fill(null);
                });
                
                // Save to Firebase
                await saveYear(year, appData.years[year]);
                
                renderYears();
                
                logActivity('added a new year', `Added year ${year} with 12 months`);
                
                hideAddYearModal();
                showCustomAlert(`‚úÖ Year ${year} added successfully with 12 months!`, 'Success', 'success');
            } else {
                showCustomAlert('‚ùå Year already exists or invalid year!', 'Error', 'danger');
            }
        }

        function showManageYearsModal() {
            if (!requireAuth()) return;
            
            const body = document.getElementById('manageYearsBody');
            body.innerHTML = '';
            
            Object.keys(appData.years).sort().forEach(year => {
                const yearData = appData.years[year];
                const totalCollection = appData.members.reduce((sum, member) => 
                    sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${year}</strong></td>
                    <td>${yearData.months.length} months</td>
                    <td><span class="taka-symbol">‡ß≥</span>${totalCollection.toFixed(2)}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteYearConfirmation('${year}')">Delete Year</button>
                    </td>
                `;
                body.appendChild(row);
            });
            
            document.getElementById('manageYearsModal').style.display = 'flex';
        }

        function hideManageYearsModal() {
            document.getElementById('manageYearsModal').style.display = 'none';
        }

        function deleteYearConfirmation(year) {
            if (!requireAuth()) return;
            
            if (Object.keys(appData.years).length <= 1) {
                showCustomAlert('‚ùå Cannot delete the only remaining year!', 'Error', 'danger');
                return;
            }

            const yearCollection = appData.members.reduce((sum, member) => 
                sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
            
            const message = yearCollection > 0
                ? `‚ö†Ô∏è Year ${year} has collected ‡ß≥${yearCollection.toFixed(2)}. Are you sure you want to delete it? This action cannot be undone!`
                : `Are you sure you want to delete year ${year}?`;

            showCustomConfirm(message, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    delete appData.years[year];
                    
                    appData.members.forEach(member => {
                        if (appData.payments[member.id]) {
                            delete appData.payments[member.id][year];
                        }
                    });
                    
                    // Delete from Firebase
                    if (isOnline) {
                        try {
                            await db.collection('years').doc(year).delete();
                        } catch (error) {
                            console.error('Error deleting year from Firebase:', error);
                        }
                    }
                    
                    renderYears();
                    updateDashboard();
                    updateReports();
                    
                    logActivity('deleted a year', `Deleted year ${year} with total collection of ‡ß≥${yearCollection.toFixed(2)}`);
                    
                    showCustomAlert(`‚úÖ Year ${year} deleted successfully!`, 'Success', 'success');
                    
                    hideManageYearsModal();
                }
            });
        }

        function deleteMonthConfirmation(year, monthIndex) {
            if (!requireAuth()) return;
            const monthName = appData.years[year].months[monthIndex];
            
            showCustomConfirm(`Are you sure you want to delete ${monthName}?`, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    appData.years[year].months.splice(monthIndex, 1);
                    appData.years[year].monthDates.splice(monthIndex, 1);
                    
                    appData.members.forEach(member => {
                        if (appData.payments[member.id]?.[year]) {
                            appData.payments[member.id][year].splice(monthIndex, 1);
                        }
                    });
                    
                    // Update in Firebase
                    await saveYear(year, appData.years[year]);
                    
                    renderYears();
                    
                    logActivity('deleted a month', `Deleted ${monthName} from year ${year}`);
                    showCustomAlert(`‚úÖ Month ${monthName} deleted successfully!`, 'Success', 'success');
                }
            });
        }

        function toggleYear(year) {
            const element = document.getElementById(`year-${year}`);
            const button = element.previousElementSibling.querySelector('.toggle-btn');
            
            if (element.classList.contains('collapsed')) {
                element.classList.remove('collapsed');
                button.textContent = '‚ñº';
            } else {
                element.classList.add('collapsed');
                button.textContent = '‚ñ∂';
            }
        }

        function updateDateRange() {
            const years = Object.keys(appData.years).sort();
            if (years.length === 0) {
                document.getElementById('dateRange').textContent = "No years available";
                return;
            }
            
            const firstYear = years[0];
            const lastYear = years[years.length - 1];
            const firstMonth = appData.years[firstYear].months[0];
            const lastMonth = appData.years[lastYear].months[appData.years[lastYear].months.length - 1];
            
            document.getElementById('dateRange').textContent = `${firstMonth} - ${lastMonth}`;
        }

        // ========== MEMBER MANAGEMENT ==========

        function showAddMemberModal() {
            if (!requireAuth()) return;
            document.getElementById('addMemberModal').style.display = 'flex';
        }

        function hideAddMemberModal() {
            document.getElementById('addMemberModal').style.display = 'none';
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberPhone').value = '';
            document.getElementById('newMemberEmail').value = '';
        }

        async function confirmAddMember() {
            const name = document.getElementById('newMemberName').value.trim();
            const phone = document.getElementById('newMemberPhone').value.trim();
            const email = document.getElementById('newMemberEmail').value.trim();
            
            if (name) {
                const newId = Math.max(...appData.members.map(m => m.id), 0) + 1;
                const newMember = {
                    id: newId,
                    name: name,
                    phone: phone || 'Not provided',
                    email: email || 'Not provided',
                    joinDate: new Date().toISOString().split('T')[0]
                };
                
                appData.members.push(newMember);
                
                appData.payments[newId] = {};
                Object.keys(appData.years).forEach(year => {
                    appData.payments[newId][year] = Array(appData.years[year].months.length).fill(null);
                });
                
                // Save to Firebase
                await saveMember(newMember);
                await savePayment(newId, Object.keys(appData.years)[0], appData.payments[newId]);
                
                renderYears();
                
                logActivity('added a new member', `Added member: ${name} (Phone: ${phone}, Email: ${email})`);
                
                hideAddMemberModal();
                showCustomAlert('‚úÖ Member added successfully!', 'Success', 'success');
            } else {
                showCustomAlert('‚ùå Please enter member name!', 'Input Error', 'warning');
            }
        }

        function showManageMembersModal() {
            if (!requireAuth()) return;
            
            const body = document.getElementById('manageMembersBody');
            body.innerHTML = '';
            
            appData.members.forEach(member => {
                const totalPaid = Object.keys(appData.years).reduce((sum, year) => 
                    sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" value="${member.name}" id="name-${member.id}" style="width: 100%;">
                    </td>
                    <td>
                        <input type="text" value="${member.phone}" id="phone-${member.id}" style="width: 100%;">
                    </td>
                    <td>
                        <input type="email" value="${member.email}" id="email-${member.id}" style="width: 100%;">
                    </td>
                    <td>${member.joinDate}</td>
                    <td><span class="taka-symbol">‡ß≥</span>${totalPaid.toFixed(2)}</td>
                    <td>
                        <button class="edit-btn" onclick="updateMember(${member.id})">üíæ Save</button>
                        <button class="delete-btn" onclick="deleteMemberConfirmation(${member.id})">üóëÔ∏è Delete</button>
                    </td>
                `;
                body.appendChild(row);
            });
            
            document.getElementById('manageMembersModal').style.display = 'flex';
        }

        function hideManageMembersModal() {
            document.getElementById('manageMembersModal').style.display = 'none';
        }

        async function updateMember(memberId) {
            const name = document.getElementById(`name-${memberId}`).value.trim();
            const phone = document.getElementById(`phone-${memberId}`).value.trim();
            const email = document.getElementById(`email-${memberId}`).value.trim();
            
            if (name) {
                const member = appData.members.find(m => m.id === memberId);
                if (member) {
                    const oldName = member.name;
                    member.name = name;
                    member.phone = phone;
                    member.email = email;
                    
                    // Save to Firebase
                    await saveMember(member);
                    
                    renderYears();
                    
                    logActivity('updated member information', `Updated member: ${oldName} -> ${name} (Phone: ${phone}, Email: ${email})`);
                    
                    showCustomAlert('‚úÖ Member updated successfully!', 'Success', 'success');
                }
            } else {
                showCustomAlert('‚ùå Member name cannot be empty!', 'Input Error', 'warning');
            }
        }

        function deleteMemberConfirmation(memberId) {
            if (!requireAuth()) return;
            const member = appData.members.find(m => m.id === memberId);
            if (!member) return;
            
            showCustomConfirm(`Are you sure you want to delete member ${member.name}? This will also delete all their payment records!`, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    appData.members = appData.members.filter(m => m.id !== memberId);
                    delete appData.payments[memberId];
                    
                    // Delete from Firebase
                    if (isOnline) {
                        try {
                            await db.collection('members').doc(memberId.toString()).delete();
                            await db.collection('payments').doc(memberId.toString()).delete();
                        } catch (error) {
                            console.error('Error deleting member from Firebase:', error);
                        }
                    }
                    
                    renderYears();
                    
                    logActivity('deleted a member', `Deleted member: ${member.name}`);
                    
                    hideManageMembersModal();
                    showCustomAlert(`‚úÖ Member ${member.name} deleted successfully!`, 'Success', 'success');
                }
            });
        }

        // ========== PAYMENT MANAGEMENT ==========

        async function updatePayment(memberId, year, monthIndex, value) {
            if (!appData.settings.isAuthenticated) {
                showCustomAlert('üîê Admin access required to modify payments!', 'Authorization Required', 'danger');
                return;
            }
            
            if (!appData.payments[memberId]) {
                appData.payments[memberId] = {};
            }
            if (!appData.payments[memberId][year]) {
                appData.payments[memberId][year] = Array(appData.years[year].months.length).fill(null);
            }
            
            const oldValue = appData.payments[memberId][year][monthIndex];
            appData.payments[memberId][year][monthIndex] = value ? parseFloat(value) : null;
            
            const member = appData.members.find(m => m.id === memberId);
            const monthName = appData.years[year].months[monthIndex];
            
            // Save to Firebase
            await savePayment(memberId, year, appData.payments[memberId][year]);
            
            renderYearTable(year);
            updateDashboard();
            
            if (oldValue !== appData.payments[memberId][year][monthIndex]) {
                const action = appData.payments[memberId][year][monthIndex] ? 
                    `added payment for ${monthName}` : `removed payment for ${monthName}`;
                
                logActivity('updated payment', 
                    `${appData.settings.currentAdmin} ${action} for ${member.name} (Year: ${year}, Amount: ‡ß≥${value || 0})`);
            }
        }

        // ========== DONATION MANAGEMENT ==========

        function showAddDonationModal() {
            if (!requireAuth()) return;
            document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('donorName').value = '';
            document.getElementById('donationAmount').value = '';
            document.getElementById('donationNote').value = '';
            document.getElementById('donationModal').style.display = 'flex';
        }

        function hideDonationModal() {
            document.getElementById('donationModal').style.display = 'none';
        }

        async function confirmAddDonation() {
            const date = document.getElementById('donationDate').value;
            const name = document.getElementById('donorName').value.trim();
            const amount = parseFloat(document.getElementById('donationAmount').value);
            const note = document.getElementById('donationNote').value.trim();
            
            if (!date || !name || !amount) {
                showCustomAlert('‚ùå Please enter Date, Donor Name, and Amount.', 'Input Error', 'warning');
                return;
            }

            const donation = { date, name, amount, note: note || '' };
            appData.donations.push(donation);
            
            // Save to Firebase
            const donationId = await saveDonation(donation);
            if (donationId) donation.id = donationId;
            
            renderDonations();
            updateDashboard();
            updateFinance();
            
            logActivity('added donation', 
                `${appData.settings.currentAdmin} added donation from ${name} (Amount: ‡ß≥${amount}, Date: ${date})`);

            hideDonationModal();
            showCustomAlert('‚úÖ Donation successfully recorded!', 'Success', 'success');
        }

        function renderDonations() {
            const donationsBody = document.getElementById('donationsBody');
            donationsBody.innerHTML = '';
            
            appData.donations.forEach((donation, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${donation.date}</td>
                    <td>${donation.name}</td>
                    <td><span class="taka-symbol">‡ß≥</span>${donation.amount.toFixed(2)}</td>
                    <td>${donation.note}</td>
                    <td class="admin-only">
                        <button class="delete-btn" onclick="deleteDonationConfirmation('${donation.id}', ${idx})">Delete</button>
                    </td>
                `;
                donationsBody.appendChild(row);
            });

            const total = appData.donations.reduce((sum, d) => sum + d.amount, 0);
            document.getElementById('totalDonations').textContent = total.toFixed(2);
        }

        function deleteDonationConfirmation(donationId, index) {
            if (!requireAuth()) return;
            const donation = appData.donations[index];
            if (!donation) return;

            showCustomConfirm(`Are you sure you want to delete the donation from ${donation.name} for ‡ß≥${donation.amount.toFixed(2)}?`, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    const deletedDonation = appData.donations.splice(index, 1)[0];
                    
                    // Delete from Firebase if it has an ID
                    if (donationId && isOnline) {
                        try {
                            await db.collection('donations').doc(donationId).delete();
                        } catch (error) {
                            console.error('Error deleting donation from Firebase:', error);
                        }
                    }
                    
                    renderDonations();
                    updateDashboard();
                    updateFinance();
                    
                    logActivity('deleted donation', 
                        `${appData.settings.currentAdmin} deleted donation from ${deletedDonation.name} (Amount: ‡ß≥${deletedDonation.amount}, Date: ${deletedDonation.date})`);
                    
                    showCustomAlert('‚úÖ Donation deleted successfully!', 'Success', 'success');
                }
            });
        }

        // ========== EXPENSE MANAGEMENT ==========

        function showAddExpenseModal() {
            if (!requireAuth()) return;
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addExpenseModal').style.display = 'flex';
        }

        function hideAddExpenseModal() {
            document.getElementById('addExpenseModal').style.display = 'none';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDescription').value = '';
        }

        async function confirmAddExpense() {
            const date = document.getElementById('expenseDate').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();
            
            if (!date || !amount || !description) {
                showCustomAlert('‚ùå Please fill all required fields!', 'Input Error', 'warning');
                return;
            }
            
            const expense = {
                date: date,
                amount: amount,
                category: category,
                description: description,
                addedBy: appData.settings.currentAdmin,
                addedOn: new Date().toISOString()
            };
            
            appData.expenses.push(expense);
            
            // Save to Firebase
            const expenseId = await saveExpense(expense);
            if (expenseId) expense.id = expenseId;
            
            renderExpenses();
            updateFinance();
            
            logActivity('added expense', 
                `${appData.settings.currentAdmin} added expense (Amount: ‡ß≥${amount}, Category: ${category}, Description: ${description})`);
            
            hideAddExpenseModal();
            showCustomAlert('‚úÖ Expense added successfully!', 'Success', 'success');
        }

        function renderExpenses() {
            const expensesBody = document.getElementById('expensesBody');
            expensesBody.innerHTML = '';
            
            appData.expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            appData.expenses.forEach((expense, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td><span class="taka-symbol">‡ß≥</span>${expense.amount.toFixed(2)}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td class="admin-only">
                        <button class="delete-btn" onclick="deleteExpenseConfirmation('${expense.id}', ${idx})">Delete</button>
                    </td>
                `;
                expensesBody.appendChild(row);
            });
        }

        function deleteExpenseConfirmation(expenseId, index) {
            if (!requireAuth()) return;
            const expense = appData.expenses[index];
            if (!expense) return;

            showCustomConfirm(`Are you sure you want to delete the expense of ‡ß≥${expense.amount.toFixed(2)} (${expense.category})?`, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    appData.expenses.splice(index, 1);
                    
                    // Delete from Firebase
                    if (expenseId && isOnline) {
                        try {
                            await db.collection('expenses').doc(expenseId).delete();
                        } catch (error) {
                            console.error('Error deleting expense from Firebase:', error);
                        }
                    }
                    
                    renderExpenses();
                    updateFinance();
                    
                    logActivity('deleted expense', 
                        `${appData.settings.currentAdmin} deleted expense (Amount: ‡ß≥${expense.amount}, Category: ${expense.category}, Description: ${expense.description})`);
                    
                    showCustomAlert('‚úÖ Expense deleted successfully!', 'Success', 'success');
                }
            });
        }

        // ========== DASHBOARD FUNCTIONS ==========

        function updateDashboard() {
            const totalCollected = getTotalCollected();
            const totalDonations = getTotalDonations();
            
            const today = new Date();
            let currentMonthCollection = 0;
            let paidMembers = 0;
            let dueMembers = 0;

            Object.keys(appData.years).forEach(year => {
                const yearData = appData.years[year];
                yearData.monthDates.forEach((monthDate, index) => {
                    // Ensure monthDate is a Date object
                    let monthDateObj;
                    if (typeof monthDate === 'string') {
                        monthDateObj = new Date(monthDate);
                    } else if (monthDate && monthDate.toDate) {
                        monthDateObj = monthDate.toDate();
                    } else {
                        monthDateObj = monthDate;
                    }
                    
                    const nextMonth = yearData.monthDates[index + 1] ? 
                        (typeof yearData.monthDates[index + 1] === 'string' ? 
                            new Date(yearData.monthDates[index + 1]) : 
                            yearData.monthDates[index + 1].toDate()) : 
                        new Date(monthDateObj.getFullYear(), monthDateObj.getMonth() + 1, 1);
                    
                    if (today >= monthDateObj && today < nextMonth) {
                        currentMonthCollection = appData.members.reduce((sum, member) => 
                            sum + (parseFloat(appData.payments[member.id]?.[year]?.[index]) || 0), 0);
                        
                        // Count paid and due members properly
                        paidMembers = appData.members.filter(member => 
                            parseFloat(appData.payments[member.id]?.[year]?.[index]) > 0).length;
                        dueMembers = appData.members.length - paidMembers;
                    }
                });
            });

            document.getElementById('totalCollected').textContent = `‡ß≥${(totalCollected + totalDonations).toFixed(2)}`;
            document.getElementById('currentMonthCollection').textContent = `‡ß≥${currentMonthCollection.toFixed(2)}`;
            document.getElementById('paidCount').textContent = paidMembers;
            document.getElementById('dueCount').textContent = dueMembers;

            updateCharts();
        }

        function updateCharts() {
            const allMonths = [];
            const monthlyData = [];
            
            Object.keys(appData.years).sort().forEach(year => {
                appData.years[year].months.forEach((month, index) => {
                    allMonths.push(month);
                    const monthTotal = appData.members.reduce((sum, member) => 
                        sum + (parseFloat(appData.payments[member.id]?.[year]?.[index]) || 0), 0);
                    monthlyData.push(monthTotal);
                });
            });

            const contributorData = appData.members.map(member => ({
                name: member.name,
                total: Object.keys(appData.years).reduce((sum, year) => 
                    sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0)
            })).sort((a, b) => b.total - a.total).slice(0, 10);

            if (monthlyChart) monthlyChart.destroy();
            if (contributorsChart) contributorsChart.destroy();

            const ctx1 = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: allMonths,
                    datasets: [{
                        label: 'Monthly Collection (‡ß≥)',
                        data: monthlyData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‡ß≥' + value;
                                }
                            }
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('contributorsChart').getContext('2d');
            contributorsChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: contributorData.map(c => c.name),
                    datasets: [{
                        label: 'Total Contribution (‡ß≥)',
                        data: contributorData.map(c => c.total),
                        backgroundColor: '#764ba2'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‡ß≥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========== FINANCE FUNCTIONS ==========

        function updateFinance() {
            const totalIncome = getTotalCollected() + getTotalDonations();
            const totalExpenditure = getTotalExpenditure();
            const currentBalance = totalIncome - totalExpenditure;
            
            document.getElementById('totalIncome').textContent = `‡ß≥${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenditure').textContent = `‡ß≥${totalExpenditure.toFixed(2)}`;
            document.getElementById('currentBalance').textContent = `‡ß≥${currentBalance.toFixed(2)}`;
            
            updateFinanceChart();
        }

        function updateFinanceChart() {
            const incomeByMonth = {};
            const expenseByMonth = {};
            
            Object.keys(appData.years).sort().forEach(year => {
                appData.years[year].months.forEach(month => {
                    incomeByMonth[month] = 0;
                    expenseByMonth[month] = 0;
                });
            });
            
            Object.keys(appData.years).sort().forEach(year => {
                appData.years[year].months.forEach((month, index) => {
                    const monthIncome = appData.members.reduce((sum, member) => 
                        sum + (parseFloat(appData.payments[member.id]?.[year]?.[index]) || 0), 0);
                    incomeByMonth[month] += monthIncome;
                });
            });
            
            appData.expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                const expenseMonth = expenseDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                if (expenseByMonth[expenseMonth] !== undefined) {
                    expenseByMonth[expenseMonth] += expense.amount;
                }
            });
            
            const months = Object.keys(incomeByMonth);
            const incomeData = months.map(month => incomeByMonth[month]);
            const expenseData = months.map(month => expenseByMonth[month]);
            
            if (financeChart) financeChart.destroy();
            
            const ctx = document.getElementById('financeChart').getContext('2d');
            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Collection (‡ß≥)',
                            data: incomeData,
                            backgroundColor: '#28a745'
                        },
                        {
                            label: 'Expenditure (‡ß≥)',
                            data: expenseData,
                            backgroundColor: '#dc3545'
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‡ß≥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function getTotalExpenditure() {
            return appData.expenses.reduce((sum, expense) => sum + expense.amount, 0);
        }

        // ========== REPORTS FUNCTIONS ==========

        function updateReports() {
            const today = new Date();
            let currentPaidMembers = [];
            let currentDueMembers = [];

            Object.keys(appData.years).forEach(year => {
                const yearData = appData.years[year];
                yearData.monthDates.forEach((monthDate, index) => {
                    // Ensure monthDate is a Date object
                    let monthDateObj;
                    if (typeof monthDate === 'string') {
                        monthDateObj = new Date(monthDate);
                    } else if (monthDate && monthDate.toDate) {
                        monthDateObj = monthDate.toDate();
                    } else {
                        monthDateObj = monthDate;
                    }
                    
                    const nextMonth = yearData.monthDates[index + 1] ? 
                        (typeof yearData.monthDates[index + 1] === 'string' ? 
                            new Date(yearData.monthDates[index + 1]) : 
                            yearData.monthDates[index + 1].toDate()) : 
                        new Date(monthDateObj.getFullYear(), monthDateObj.getMonth() + 1, 1);
                    
                    if (today >= monthDateObj && today < nextMonth) {
                        currentPaidMembers = appData.members.filter(member => 
                            parseFloat(appData.payments[member.id]?.[year]?.[index]) > 0);
                        currentDueMembers = appData.members.filter(member => 
                            !parseFloat(appData.payments[member.id]?.[year]?.[index]) > 0);
                    }
                });
            });

            document.getElementById('paidCountReport').textContent = currentPaidMembers.length;
            document.getElementById('dueCountReport').textContent = currentDueMembers.length;

            const paidList = document.getElementById('paidList');
            const dueList = document.getElementById('dueList');
            
            paidList.innerHTML = '';
            dueList.innerHTML = '';

            currentPaidMembers.forEach(member => {
                const div = document.createElement('div');
                div.className = 'member-item paid';
                div.textContent = member.name;
                paidList.appendChild(div);
            });

            currentDueMembers.forEach(member => {
                const div = document.createElement('div');
                div.className = 'member-item due';
                div.textContent = member.name;
                dueList.appendChild(div);
            });

            const contributionSummary = document.getElementById('contributionSummary');
            contributionSummary.innerHTML = '';
            
            appData.members.forEach(member => {
                const total = Object.keys(appData.years).reduce((sum, year) => 
                    sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                
                let monthsPaid = 0;
                let totalMonths = 0;
                
                Object.keys(appData.years).forEach(year => {
                    const yearPayments = appData.payments[member.id]?.[year] || [];
                    monthsPaid += yearPayments.filter(val => val !== null && parseFloat(val) > 0).length;
                    totalMonths += yearPayments.length;
                });
                
                const monthsDue = totalMonths - monthsPaid;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${member.name}</strong></td>
                    <td><span class="taka-symbol">‡ß≥</span>${total.toFixed(2)}</td>
                    <td>${monthsPaid}</td>
                    <td>${monthsDue}</td>
                    <td class="admin-only">
                        <button class="delete-btn" onclick="deleteMemberConfirmation(${member.id})">Delete</button>
                    </td>
                `;
                contributionSummary.appendChild(row);
            });
        }

        function toggleMemberList(type) {
            const section = document.getElementById(type + 'ListSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }

        // ========== ACTIVITY LOGS ==========

        function renderActivityLogs() {
            const logsContainer = document.getElementById('activityLogs');
            logsContainer.innerHTML = '';
            
            if (appData.activityLogs.length === 0) {
                logsContainer.innerHTML = '<div class="log-entry">No activity logs yet.</div>';
                return;
            }
            
            appData.activityLogs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timestamp = new Date(log.timestamp).toLocaleString();
                
                logEntry.innerHTML = `
                    <div>
                        <span class="log-timestamp">${timestamp}</span> - 
                        <span class="log-admin">${log.admin}</span> 
                        <span class="log-action">${log.action}</span>
                    </div>
                    <div class="log-details">${log.details}</div>
                `;
                
                logsContainer.appendChild(logEntry);
            });
        }

        // ========== EXPORT FUNCTIONALITY ==========

        function showExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
            
            const yearSelect = document.getElementById('exportYearSelect');
            yearSelect.innerHTML = '';
            Object.keys(appData.years).sort().forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            document.getElementById('exportData').addEventListener('change', function() {
                const yearGroup = document.getElementById('yearSelectionGroup');
                yearGroup.style.display = this.value === 'members' ? 'block' : 'none';
            });
        }

        function hideExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function exportData() {
            const format = document.getElementById('exportFormat').value;
            const dataType = document.getElementById('exportData').value;
            const selectedYear = document.getElementById('exportYearSelect').value;
            
            switch(format) {
                case 'excel':
                    exportToExcel(dataType, selectedYear);
                    break;
                case 'pdf':
                    exportToPDF(dataType, selectedYear);
                    break;
            }
            
            hideExportModal();
            // Don't log activity for public exports
            if (appData.settings.isAuthenticated) {
                logActivity('exported data', `Exported ${dataType} data as ${format.toUpperCase()}`);
            }
        }

        function exportToExcel(dataType, selectedYear) {
            try {
                const wb = XLSX.utils.book_new();
                let fileName = `Rangdhanu_Charity_Report_${new Date().toISOString().split('T')[0]}`;
                const members = appData.members;
                const payments = appData.payments;
                const years = appData.years;

                const addSummarySheet = () => {
                    const summaryData = [
                        ['Rangdhanu Charity Fund - Financial Summary'],
                        ['Generated on:', new Date().toLocaleString()],
                        ['App Version:', appData.appVersion],
                        [''],
                        ['KEY STATISTICS'],
                        ['Total Members:', members.length],
                        ['Total Member Collections (‡ß≥):', getTotalCollected().toFixed(2)],
                        ['Total Public Donations (‡ß≥):', getTotalDonations().toFixed(2)],
                        ['Total Collection (‡ß≥):', (getTotalCollected() + getTotalDonations()).toFixed(2)],
                        ['Total Expenditure (‡ß≥):', getTotalExpenditure().toFixed(2)],
                        ['Current Balance (‡ß≥):', (getTotalCollected() + getTotalDonations() - getTotalExpenditure()).toFixed(2)]
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, ws, "Financial Summary");
                };

                if (dataType === 'financial' || dataType === 'all') {
                    addSummarySheet();

                    const expenseData = [['Date', 'Amount (‡ß≥)', 'Category', 'Description', 'Added By', 'Added On']];
                    appData.expenses.forEach(expense => {
                        expenseData.push([
                            expense.date, 
                            expense.amount, 
                            expense.category, 
                            expense.description,
                            expense.addedBy,
                            new Date(expense.addedOn).toLocaleString()
                        ]);
                    });
                    const ws3 = XLSX.utils.aoa_to_sheet(expenseData);
                    XLSX.utils.book_append_sheet(wb, ws3, "Detailed Expenses");
                    fileName = 'Rangdhanu_Financial_Report';
                }

                if (dataType === 'members' || dataType === 'all') {
                    const paymentData = [];
                    const selectedYearRange = dataType === 'members' && selectedYear ? [selectedYear] : Object.keys(years).sort();
                    
                    const headers = ['Member Name', 'Phone', 'Email', 'Join Date'];
                    selectedYearRange.forEach(year => {
                        years[year].months.forEach(month => {
                            headers.push(`${year} - ${month} (‡ß≥)`);
                        });
                    });
                    headers.push('Total Contribution (‡ß≥)');
                    paymentData.push(headers);
                    
                    members.forEach(member => {
                        const row = [member.name, member.phone, member.email, member.joinDate];
                        let total = 0;
                        
                        selectedYearRange.forEach(year => {
                            years[year].months.forEach((month, mIdx) => {
                                const amount = payments[member.id]?.[year]?.[mIdx] || 0;
                                row.push(amount);
                                total += parseFloat(amount) || 0;
                            });
                        });
                        row.push(total.toFixed(2));
                        paymentData.push(row);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(paymentData);
                    XLSX.utils.book_append_sheet(wb, ws, `Member Payments ${selectedYear || 'All'}`);
                    
                    if (dataType === 'members') {
                        addSummarySheet();
                        fileName = `Rangdhanu_Members_Sheet_${selectedYear || 'All'}`;
                    }
                }

                if (dataType === 'donations' || dataType === 'all') {
                    const donationData = [['Date', 'Donor Name', 'Amount (‡ß≥)', 'Note']];
                    appData.donations.forEach(donation => {
                        donationData.push([donation.date, donation.name, donation.amount.toFixed(2), donation.note]);
                    });
                    
                    const ws2 = XLSX.utils.aoa_to_sheet(donationData);
                    XLSX.utils.book_append_sheet(wb, ws2, "Public Donations");
                    
                    if (dataType === 'donations') {
                        addSummarySheet();
                        fileName = 'Rangdhanu_Donations_Report';
                    }
                }

                if (dataType === 'expenses') {
                    const expenseData = [['Date', 'Amount (‡ß≥)', 'Category', 'Description', 'Added By', 'Added On']];
                    appData.expenses.forEach(expense => {
                        expenseData.push([
                            expense.date, 
                            expense.amount.toFixed(2), 
                            expense.category, 
                            expense.description,
                            expense.addedBy,
                            new Date(expense.addedOn).toLocaleString()
                        ]);
                    });
                    const ws3 = XLSX.utils.aoa_to_sheet(expenseData);
                    XLSX.utils.book_append_sheet(wb, ws3, "Detailed Expenses");
                    addSummarySheet();
                    fileName = 'Rangdhanu_Expenses_Report';
                }
                
                if (dataType === 'logs' || dataType === 'all') {
                    const logData = [['Timestamp', 'Admin', 'Action', 'Details']];
                    appData.activityLogs.forEach(log => {
                        logData.push([
                            new Date(log.timestamp).toLocaleString(),
                            log.admin,
                            log.action,
                            log.details
                        ]);
                    });
                    
                    const ws4 = XLSX.utils.aoa_to_sheet(logData);
                    XLSX.utils.book_append_sheet(wb, ws4, "Activity Logs");
                    if (dataType === 'logs') {
                        fileName = 'Rangdhanu_Activity_Logs';
                    }
                }

                XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`);
                showCustomAlert('‚úÖ Excel file exported successfully with comprehensive sheets!', 'Export Success', 'success');
            } catch (error) {
                showCustomAlert('‚ùå Error exporting Excel file: ' + error.message, 'Export Error', 'danger');
            }
        }

        function exportToPDF(dataType, selectedYear) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const title = 'Rangdhanu Charity Fund - Financial Report';
                doc.setFontSize(20);
                doc.setTextColor(40, 40, 40);
                doc.text(title, 105, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated on: ${new Date().toLocaleDateString()} | Data: ${document.getElementById('exportData').options[document.getElementById('exportData').selectedIndex].text}`, 105, 22, { align: 'center' });
                
                let yPosition = 35;
                const margin = 14;
                const primaryColor = [102, 126, 234]; // #667eea

                const addSectionTitle = (titleText) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.setFontSize(16);
                    doc.setTextColor(40, 40, 40);
                    doc.text(titleText, margin, yPosition);
                    yPosition += 8;
                };

                const addSummaryTable = () => {
                    const totalIncome = getTotalCollected() + getTotalDonations();
                    const totalExpenditure = getTotalExpenditure();
                    const currentBalance = totalIncome - totalExpenditure;

                    addSectionTitle('I. Overall Financial Summary');

                    const summaryData = [
                        ['Total Members', appData.members.length.toString()],
                        ['Total Member Collections', `‡ß≥${getTotalCollected().toFixed(2)}`],
                        ['Total Public Donations', `‡ß≥${getTotalDonations().toFixed(2)}`],
                        ['Total Collection (Collection + Donations)', `‡ß≥${totalIncome.toFixed(2)}`],
                        ['Total Expenditure', `‡ß≥${totalExpenditure.toFixed(2)}`],
                        ['Current Balance', `‡ß≥${currentBalance.toFixed(2)}`]
                    ];

                    doc.autoTable({
                        startY: yPosition,
                        head: [['Metric', 'Value']],
                        body: summaryData,
                        theme: 'grid',
                        headStyles: { fillColor: primaryColor, fontSize: 10 },
                        styles: { fontSize: 10, cellPadding: 2 },
                        columnStyles: { 0: { fontStyle: 'bold' } },
                        margin: { left: margin, right: margin }
                    });
                    yPosition = doc.lastAutoTable.finalY + 15;
                };

                addSummaryTable();

                if (dataType === 'members' || dataType === 'all') {
                    addSectionTitle(`II. Detailed Member Payments - ${selectedYear || 'All Time'}`);
                    
                    const memberRows = [];
                    const allMemberHeaders = ['Member', 'Total ‡ß≥', 'Paid Months', 'Due Months'];
                    
                    appData.members.forEach(member => {
                        let total = 0;
                        let paidMonths = 0;
                        let totalMonths = 0;
                        
                        Object.keys(appData.years).sort().forEach(year => {
                            if (dataType === 'members' && selectedYear && year !== selectedYear) return;
                            const yearPayments = appData.payments[member.id]?.[year] || [];
                            paidMonths += yearPayments.filter(val => val !== null && parseFloat(val) > 0).length;
                            totalMonths += yearPayments.length;
                            total += yearPayments.reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
                        });
                        
                        memberRows.push([
                            member.name, 
                            `‡ß≥${total.toFixed(2)}`, 
                            paidMonths, 
                            (totalMonths - paidMonths)
                        ]);
                    });
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: [allMemberHeaders],
                        body: memberRows,
                        theme: 'grid',
                        headStyles: { fillColor: primaryColor, fontSize: 10 },
                        styles: { fontSize: 9, cellPadding: 2 },
                        columnStyles: { 1: { fontStyle: 'bold' } },
                        margin: { left: margin, right: margin }
                    });
                    yPosition = doc.lastAutoTable.finalY + 15;
                }

                if (dataType === 'donations' || dataType === 'all' || dataType === 'financial') {
                    addSectionTitle('III. Public Donations Records');
                    
                    const donationHeaders = ['Date', 'Donor Name', 'Amount (‡ß≥)', 'Note'];
                    const donationRows = appData.donations.map(d => [
                        d.date, 
                        d.name, 
                        `‡ß≥${d.amount.toFixed(2)}`, 
                        d.note.substring(0, 50) + (d.note.length > 50 ? '...' : '')
                    ]);
                    
                    if (donationRows.length > 0) {
                        doc.autoTable({
                            startY: yPosition,
                            head: [donationHeaders],
                            body: donationRows,
                            theme: 'grid',
                            headStyles: { fillColor: primaryColor, fontSize: 10 },
                            styles: { fontSize: 9, cellPadding: 2 },
                            margin: { left: margin, right: margin }
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('No public donation records found.', margin, yPosition + 5);
                        doc.lastAutoTable = { finalY: yPosition + 10 };
                    }
                    yPosition = doc.lastAutoTable.finalY + 15;
                }
                
                if (dataType === 'expenses' || dataType === 'all' || dataType === 'financial') {
                    addSectionTitle('IV. Detailed Expenditure Records');

                    const expenseHeaders = ['Date', 'Amount (‡ß≥)', 'Category', 'Description'];
                    const expenseRows = appData.expenses.map(e => [
                        e.date, 
                        `‡ß≥${e.amount.toFixed(2)}`, 
                        e.category, 
                        e.description.substring(0, 70) + (e.description.length > 70 ? '...' : '')
                    ]);
                    
                    if (expenseRows.length > 0) {
                        doc.autoTable({
                            startY: yPosition,
                            head: [expenseHeaders],
                            body: expenseRows,
                            theme: 'grid',
                            headStyles: { fillColor: primaryColor, fontSize: 10 },
                            styles: { fontSize: 9, cellPadding: 2 },
                            margin: { left: margin, right: margin }
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('No expenditure records found.', margin, yPosition + 5);
                        doc.lastAutoTable = { finalY: yPosition + 10 };
                    }
                    yPosition = doc.lastAutoTable.finalY + 15;
                }

                if (dataType === 'logs' || dataType === 'all') {
                    addSectionTitle('V. Admin Activity Logs');
                    
                    const logHeaders = ['Timestamp', 'Admin', 'Action', 'Details'];
                    const logRows = appData.activityLogs.map(log => [
                        new Date(log.timestamp).toLocaleString(),
                        log.admin,
                        log.action,
                        log.details.substring(0, 80) + (log.details.length > 80 ? '...' : '')
                    ]);
                    
                    if (logRows.length > 0) {
                        doc.autoTable({
                            startY: yPosition,
                            head: [logHeaders],
                            body: logRows.slice(0, 50),
                            theme: 'grid',
                            headStyles: { fillColor: primaryColor, fontSize: 10 },
                            styles: { fontSize: 8, cellPadding: 1 },
                            margin: { left: margin, right: margin }
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('No activity logs found.', margin, yPosition + 5);
                    }
                }
                
                doc.save(`Rangdhanu_Charity_Fund_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                showCustomAlert('‚úÖ PDF report exported successfully with comprehensive details!', 'Export Success', 'success');
            } catch (error) {
                showCustomAlert('‚ùå Error exporting PDF: ' + error.message, 'Export Error', 'danger');
            }
        }

        // ========== SYSTEM MANAGEMENT ==========

        function showManageModal() {
            if (!requireAuth()) return;
            document.getElementById('manageModal').style.display = 'flex';
        }

        function hideManageModal() {
            document.getElementById('manageModal').style.display = 'none';
        }

        function showBackupModal() {
            if (!requireAuth()) return;
            document.getElementById('backupModal').style.display = 'flex';
        }

        function hideBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        function showRestoreModal() {
            if (!requireAuth()) return;
            document.getElementById('restoreModal').style.display = 'flex';
            loadBackups();
        }

        function hideRestoreModal() {
            document.getElementById('restoreModal').style.display = 'none';
        }

        async function createBackup() {
            try {
                showLoading('Creating backup...');
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    createdBy: appData.settings.currentAdmin,
                    data: {
                        years: appData.years,
                        members: appData.members,
                        payments: appData.payments,
                        donations: appData.donations,
                        expenses: appData.expenses,
                        settings: appData.settings
                    }
                };
                
                await db.collection('backups').add(backupData);
                
                hideBackupModal();
                hideLoading();
                showCustomAlert('‚úÖ Backup created successfully!', 'Backup Success', 'success');
                logActivity('created backup', `Backup created by ${appData.settings.currentAdmin}`);
            } catch (error) {
                hideLoading();
                showCustomAlert('‚ùå Error creating backup: ' + error.message, 'Backup Error', 'danger');
            }
        }

        async function loadBackups() {
            try {
                const backupSelect = document.getElementById('backupSelect');
                backupSelect.innerHTML = '<option value="">Loading backups...</option>';
                
                const backupsSnapshot = await db.collection('backups')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                backupSelect.innerHTML = '';
                
                if (backupsSnapshot.empty) {
                    backupSelect.innerHTML = '<option value="">No backups found</option>';
                    return;
                }
                
                backupsSnapshot.forEach(doc => {
                    const backup = doc.data();
                    const date = new Date(backup.timestamp).toLocaleString();
                    backupSelect.innerHTML += `<option value="${doc.id}">${date} (by ${backup.createdBy})</option>`;
                });
            } catch (error) {
                console.error('Error loading backups:', error);
                document.getElementById('backupSelect').innerHTML = '<option value="">Error loading backups</option>';
            }
        }

        async function restoreBackup() {
            const backupId = document.getElementById('backupSelect').value;
            if (!backupId) {
                showCustomAlert('‚ùå Please select a backup to restore!', 'Restore Error', 'warning');
                return;
            }
            
            showCustomConfirm('‚ö†Ô∏è This will overwrite all current data. Are you sure you want to restore this backup?', 'Confirm Restore', 'danger', async (confirmed) => {
                if (confirmed) {
                    try {
                        showLoading('Restoring backup...');
                        
                        const backupDoc = await db.collection('backups').doc(backupId).get();
                        if (!backupDoc.exists) {
                            throw new Error('Backup not found');
                        }
                        
                        const backupData = backupDoc.data().data;
                        
                        // Restore data
                        appData.years = backupData.years;
                        appData.members = backupData.members;
                        appData.payments = backupData.payments;
                        appData.donations = backupData.donations;
                        appData.expenses = backupData.expenses;
                        appData.settings = { ...appData.settings, ...backupData.settings };
                        
                        // Save restored data to main collections
                        await saveData();
                        
                        // Re-render everything
                        renderYears();
                        renderDonations();
                        renderExpenses();
                        updateDashboard();
                        updateReports();
                        updateFinance();
                        
                        hideRestoreModal();
                        hideLoading();
                        showCustomAlert('‚úÖ Backup restored successfully!', 'Restore Success', 'success');
                        logActivity('restored backup', `Backup restored by ${appData.settings.currentAdmin}`);
                    } catch (error) {
                        hideLoading();
                        showCustomAlert('‚ùå Error restoring backup: ' + error.message, 'Restore Error', 'danger');
                    }
                }
            });
        }

        // ========== UTILITY FUNCTIONS ==========

        function getTotalCollected() {
            let total = 0;
            appData.members.forEach(member => {
                Object.keys(appData.years).forEach(year => {
                    total += (appData.payments[member.id]?.[year] || []).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
                });
            });
            return total;
        }

        function getTotalDonations() {
            return appData.donations.reduce((sum, d) => sum + d.amount, 0);
        }

        // ========== INITIALIZATION ==========

        async function initializeApp() {
            showLoading('Initializing application...');
            
            // Set up network listeners
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            try {
                // Initialize Firebase
                await initializeFirebase();
                
                // Initialize the rest of the app
                initializePayments();
                renderYears();
                renderDonations();
                renderExpenses();
                updateDashboard();
                updateReports();
                updateFinance();
                updateDateRange();
                updateLoginStatus();
                updateAdminControls();
                
                hideLoading();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('App initialization failed:', error);
                hideLoading();
                showCustomAlert('Failed to initialize app. Please refresh the page.', 'Error', 'danger');
            }
        }

        // Initialize the application
        initializeApp();

        // Auto-save every 30 seconds
        setInterval(saveData, 30000);
    </script>
</body>
</html>
