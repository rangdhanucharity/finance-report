<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-status-bar-style" content="default">
    <title>Rangdhanu Charity Fund Tracker</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 12px;
            }
            
            .header {
                padding: 20px 15px !important;
            }
            
            .header h1 {
                font-size: 1.8em !important;
            }
            
            .admin-controls {
                position: static !important;
                margin-top: 15px;
                justify-content: center;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                padding: 12px !important;
            }
            
            .tab-content {
                padding: 15px !important;
            }
            
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
                gap: 10px !important;
            }
            
            .summary-card .value {
                font-size: 1.5em !important;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 600px;
            }
            
            .export-options {
                flex-direction: column;
            }
            
            .member-list {
                grid-template-columns: 1fr !important;
            }
            
            .modal-content {
                min-width: 90% !important;
                max-width: 95% !important;
                padding: 20px !important;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .legend {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-sort-controls {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em !important;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr !important;
            }
            
            .admin-btn {
                padding: 6px 10px !important;
                font-size: 0.8em !important;
            }
        }

        /* Desktop Optimizations */
        @media (min-width: 1200px) {
            .container {
                margin: 20px auto;
            }
            
            .tab-content {
                padding: 40px !important;
            }
        }

        /* Existing Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .admin-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .admin-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .admin-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .admin-btn.disabled:hover {
            background: rgba(255,255,255,0.2);
            transform: none;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 1em;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        input[type="number"], input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .cell-white { background: white; }
        .cell-yellow { background: #fff3cd; }
        .cell-red { background: #f8d7da; }
        .cell-green { background: #d4edda; }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        canvas {
            max-width: 100%;
        }

        .member-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .member-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .member-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .member-item.paid {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .member-item.due {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .add-member-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }

        .add-member-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .add-member-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .add-member-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
		
		#customDialogModal {
			z-index: 2000 !important;
		}

		#customDialogModal .modal-content {
			z-index: 2001 !important;
		}

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-width: 400px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            opacity: 0.5;
            transform: none;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8em;
        }

        .delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .edit-btn {
            background: #ffc107;
            color: black;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 0.8em;
        }

        .edit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .month-header {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .login-modal {
            display: flex;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-logged-in {
            background: #28a745;
            color: white;
        }

        .status-logged-out {
            background: #dc3545;
            color: white;
        }

        .year-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .year-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-actions {
            display: flex;
            gap: 5px;
        }

        .toggle-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .collapsible {
            display: block;
        }

        .collapsible.collapsed {
            display: none;
        }

        .admin-contacts {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .admin-contact-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .taka-symbol {
            font-family: Arial, sans-serif;
            font-weight: bold;
        }

        .clickable-header {
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
            border-radius: 5px;
        }

        .clickable-header:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .manage-years-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .manage-years-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .sync-success {
            background: #28a745;
            color: white;
        }

        .sync-error {
            background: #dc3545;
            color: white;
        }

        .sync-pending {
            background: #ffc107;
            color: black;
        }

        .finance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .finance-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .finance-card.income {
            border-left-color: #28a745;
        }

        .finance-card.expense {
            border-left-color: #dc3545;
        }

        .finance-card.balance {
            border-left-color: #17a2b8;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #6c757d;
            font-size: 0.8em;
        }

        .log-admin {
            font-weight: bold;
            color: #667eea;
        }

        .log-action {
            font-weight: bold;
        }

        .log-details {
            margin-top: 5px;
            padding-left: 15px;
            color: #495057;
        }
        
        /* Hide admin controls when not logged in */
        .admin-only {
            display: none;
        }
        
        .admin-logged-in .admin-only {
            display: inline-flex;
        }
        
        /* Auto-logout warning */
        .logout-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 3000;
            text-align: center;
            max-width: 400px;
            display: none;
        }
        
        .logout-warning h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }
        
        .logout-countdown {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545;
            margin: 15px 0;
        }

        /* Search and Sort Styles */
        .search-sort-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .sort-options {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .sort-select:focus {
            outline: none;
            border-color: #667eea;
        }

		/* Recycle Bin Styles */
		.recycle-bin-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 8px 15px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 0.9em;
			transition: all 0.3s;
		}

		.recycle-bin-btn:hover {
			background: #5a6268;
		}

		.recycle-bin-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			padding-bottom: 10px;
			border-bottom: 2px solid #dee2e6;
		}

		.recycle-bin-stats {
			font-size: 0.9em;
			color: #6c757d;
		}

		.recycle-bin-item {
			padding: 15px;
			background: #f8f9fa;
			border-radius: 8px;
			border-left: 4px solid #6c757d;
			margin-bottom: 10px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			transition: all 0.3s;
		}

		.recycle-bin-item:hover {
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			transform: translateX(5px);
		}

		.recycle-bin-item.expired {
			border-left-color: #dc3545;
			background: #f8d7da;
		}

		.recycle-bin-item.member-type {
			border-left-color: #007bff;
		}

		.recycle-bin-item.year-type {
			border-left-color: #28a745;
		}

		.recycle-bin-item.month-type {
			border-left-color: #ffc107;
		}

		.recycle-bin-item.donation-type {
			border-left-color: #17a2b8;
		}

		.recycle-bin-item.expense-type {
			border-left-color: #6f42c1;
		}

		.recycle-bin-item-info {
			flex: 1;
		}

		.recycle-bin-item-type {
			font-weight: bold;
			color: #495057;
			display: inline-block;
			padding: 3px 8px;
			border-radius: 4px;
			font-size: 0.85em;
			margin-bottom: 5px;
		}

		.recycle-bin-item-type.member-type-badge {
			background: #cfe2ff;
			color: #004085;
		}

		.recycle-bin-item-type.year-type-badge {
			background: #d4edda;
			color: #155724;
		}

		.recycle-bin-item-type.month-type-badge {
			background: #fff3cd;
			color: #856404;
		}

		.recycle-bin-item-type.donation-type-badge {
			background: #d1ecf1;
			color: #0c5460;
		}

		.recycle-bin-item-type.expense-type-badge {
			background: #e2d9f3;
			color: #3d1a5f;
		}

		.recycle-bin-item-name {
			margin: 5px 0;
			font-size: 1.1em;
			font-weight: 600;
			color: #333;
		}

		.recycle-bin-item-details {
			font-size: 0.9em;
			color: #6c757d;
			margin-top: 3px;
		}

		.recycle-bin-item-actions {
			display: flex;
			gap: 10px;
		}

		.recycle-bin-restore-btn {
			background: #28a745;
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 0.9em;
			transition: all 0.3s;
		}

		.recycle-bin-restore-btn:hover {
			background: #218838;
			transform: translateY(-2px);
		}

		.recycle-bin-restore-btn:disabled {
			background: #6c757d;
			cursor: not-allowed;
			transform: none;
		}

		.recycle-bin-delete-btn {
			background: #dc3545;
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 0.9em;
			transition: all 0.3s;
		}

		.recycle-bin-delete-btn:hover {
			background: #c82333;
			transform: translateY(-2px);
		}

		.days-left {
			font-size: 0.85em;
			padding: 3px 8px;
			border-radius: 4px;
			background: #28a745;
			color: white;
			margin-left: 8px;
			font-weight: 600;
		}

		.days-left.warning {
			background: #ffc107;
			color: #000;
		}

		.days-left.expired {
			background: #dc3545;
			color: white;
		}

		/* Recycle Bin Loading State */
		.recycle-bin-loading {
			text-align: center;
			padding: 40px 20px;
			color: #6c757d;
		}

		.recycle-bin-empty {
			text-align: center;
			padding: 60px 20px;
			color: #6c757d;
			font-style: italic;
			font-size: 1.1em;
		}

		.recycle-bin-section {
			margin-bottom: 25px;
		}

		.recycle-bin-section-title {
			font-weight: bold;
			font-size: 1.1em;
			margin-bottom: 15px;
			padding: 10px 15px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-radius: 8px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.section-count {
			background: rgba(255,255,255,0.3);
			padding: 3px 10px;
			border-radius: 12px;
			font-size: 0.9em;
		}

		.recycle-bin-filter-tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
			flex-wrap: wrap;
		}

		.filter-tab {
			padding: 8px 16px;
			border: 2px solid #dee2e6;
			background: white;
			border-radius: 6px;
			cursor: pointer;
			transition: all 0.3s;
			font-size: 0.9em;
		}

		.filter-tab:hover {
			border-color: #667eea;
			background: #f8f9fa;
		}

		.filter-tab.active {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-color: #667eea;
		}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay" style="display: flex;">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div id="loadingText">Loading...</div>
        </div>
    </div>

    <div class="sync-status" id="syncStatus" style="display: none;"></div>
    
    <div class="logout-warning" id="logoutWarning">
        <h3>Session Timeout Warning</h3>
        <p>You will be logged out due to inactivity in:</p>
        <div class="logout-countdown" id="logoutCountdown">5:00</div>
        <p>Move your mouse or press any key to continue your session.</p>
        <button class="btn btn-primary" onclick="continueSession()">Continue Session</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Rangdhanu Charity Fund</h1>
            <p id="dateRange">Loading...</p>
            <div class="admin-controls">
                <span id="loginStatus" class="status-badge status-logged-out">Logged Out</span>
                <button class="admin-btn" onclick="showLoginModal()" id="loginBtn">üîê Admin Login</button>
                <button class="admin-btn" onclick="showExportModal()">üì§ Export Data</button>
                <button class="admin-btn admin-only" id="manageBtn" onclick="showManageModal()">‚öôÔ∏è Manage</button>
                <button class="admin-btn admin-only recycle-bin-btn" onclick="showRecycleBinModal()">üóëÔ∏è Recycle Bin</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('collection')">üíµ Collection Sheet</button>
            <button class="tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reports</button>
            <button class="tab" onclick="switchTab('finance')">üí∞ Finance</button>
            <button class="tab" onclick="switchTab('logs')">üìã Activity Logs</button>
        </div>

        <div id="collection" class="tab-content active">
            <div class="search-sort-controls">
                <div class="search-box">
                    <input type="text" class="search-input" id="memberSearch" placeholder="Search members by name, phone, email...">
                    <span class="search-icon">üîç</span>
                </div>
                <div class="sort-options">
                    <label for="sortMembers">Sort by:</label>
                    <select class="sort-select" id="sortMembers" onchange="sortMembers()">
                        <option value="name">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="current-payment">Current Month Payment</option>
                        <option value="total-payment">Total Payment</option>
                    </select>
                </div>
            </div>

            <div class="export-options">
                <button class="add-member-btn admin-only" id="addMemberBtn" onclick="showAddMemberModal()">+ Add New Member</button>
                <button class="add-member-btn admin-only" id="addYearBtn" onclick="showAddYearModal()">+ Add New Year</button>
                <button class="add-member-btn admin-only" id="manageMembersBtn" onclick="showManageMembersModal()">üë• Manage Members</button>
                <button class="add-member-btn admin-only" id="manageYearsBtn" onclick="showManageYearsModal()">üìÖ Manage Years</button>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color cell-white"></div>
                    <span>Future Month</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color cell-yellow"></div>
                    <span>Current Month (Before 10th)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color cell-red"></div>
                    <span>Overdue (After 10th)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color cell-green"></div>
                    <span>Paid</span>
                </div>
            </div>

            <div id="yearsContainer">
                </div>

            <h3 style="margin: 30px 0 15px 0;">One-Time Public Donations</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Donor Name</th>
                            <th>Amount (‡ß≥)</th>
                            <th>Note</th>
                            <th class="admin-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="donationsBody"></tbody>
                </table>
            </div>
            <button class="add-member-btn admin-only" id="addDonationBtn" onclick="showAddDonationModal()">+ Add Donation</button>
            <div style="margin-top: 15px; font-weight: bold;">
                Total Public Donations: <span class="taka-symbol">‡ß≥</span><span id="totalDonations">0</span>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Total Collected</h3>
                    <div class="value" id="totalCollected">‡ß≥0</div>
                </div>
                <div class="summary-card">
                    <h3>Current Month Collection</h3>
                    <div class="value" id="currentMonthCollection">‡ß≥0</div>
                </div>
                <div class="summary-card">
                    <h3>Paid Members</h3>
                    <div class="value" id="paidCount">0</div>
                </div>
                <div class="summary-card">
                    <h3>Due Members</h3>
                    <div class="value" id="dueCount">0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">Monthly Collection Trend</h3>
                <canvas id="monthlyChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">Top Contributors</h3>
                <canvas id="contributorsChart"></canvas>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <!-- ADDED: Search and Sort Controls for Reports Tab -->
            <div class="search-sort-controls">
                <div class="search-box">
                    <input type="text" class="search-input" id="reportsSearch" placeholder="Search members by name...">
                    <span class="search-icon">üîç</span>
                </div>
                <div class="sort-options">
                    <label for="sortReports">Sort by:</label>
                    <select class="sort-select" id="sortReports" onchange="sortReports()">
                        <option value="name">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="total-paid">Total Paid (High to Low)</option>
                        <option value="total-paid-asc">Total Paid (Low to High)</option>
                        <option value="months-paid">Months Paid (High to Low)</option>
                        <option value="months-due">Months Due (High to Low)</option>
                    </select>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card clickable-header" onclick="toggleMemberList('paid')">
                    <h3>‚úÖ Paid Members (Current Month)</h3>
                    <div class="value" id="paidCountReport">0</div>
                    <small>Click to view/hide list</small>
                </div>
                <div class="summary-card clickable-header" onclick="toggleMemberList('due')">
                    <h3>‚ùå Due Members (Current Month)</h3>
                    <div class="value" id="dueCountReport">0</div>
                    <small>Click to view/hide list</small>
                </div>
            </div>

            <div id="paidListSection" style="display: none;">
                <h3 style="margin: 20px 0 15px 0;">Paid Members List</h3>
                <div class="member-list" id="paidList"></div>
            </div>

            <div id="dueListSection" style="display: none;">
                <h3 style="margin: 20px 0 15px 0;">Due Members List</h3>
                <div class="member-list" id="dueList"></div>
            </div>

            <h3 style="margin: 30px 0 20px 0;">Member Contribution Summary</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Member Name</th>
                            <th>Total Contribution</th>
                            <th>Months Paid</th>
                            <th>Months Due</th>
                            <th class="admin-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contributionSummary"></tbody>
                </table>
            </div>
        </div>

        <div id="finance" class="tab-content">
            <div class="finance-summary">
                <div class="finance-card income">
                    <h3>Total Collection</h3>
                    <div class="value" id="totalIncome">‡ß≥0</div>
                </div>
                <div class="finance-card expense">
                    <h3>Total Expenditure</h3>
                    <div class="value" id="totalExpenditure">‡ß≥0</div>
                </div>
                <div class="finance-card balance">
                    <h3>Current Balance</h3>
                    <div class="value" id="currentBalance">‡ß≥0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">Collection vs Expenditure</h3>
                <canvas id="financeChart"></canvas>
            </div>

            <div class="export-options">
                <button class="add-member-btn admin-only" id="addExpenseBtn" onclick="showAddExpenseModal()">+ Add Expense</button>
            </div>

            <h3 style="margin: 30px 0 15px 0;">Expenditure Records</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount (‡ß≥)</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th class="admin-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody"></tbody>
                </table>
            </div>
        </div>

        <div id="logs" class="tab-content">
            <h3 style="margin-bottom: 20px;">Admin Activity Logs</h3>
            <div class="table-container">
                <div id="activityLogs">
                    </div>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h3>üîê Admin Login - Rangdhanu Charity Fund</h3>
            <div class="form-group">
                <label for="adminName">Admin Name:</label>
                <input type="text" id="adminName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideLoginModal()">Cancel</button>
                <button class="btn btn-primary" onclick="login()">Login</button>
            </div>
        </div>
    </div>

    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Expense</h3>
            <div class="form-group">
                <label for="expenseDate">Date:</label>
                <input type="date" id="expenseDate" value="">
            </div>
            <div class="form-group">
                <label for="expenseAmount">Amount (‡ß≥):</label>
                <input type="number" id="expenseAmount" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label for="expenseCategory">Category:</label>
                <select id="expenseCategory">
                    <option value="Operational">Operational</option>
                    <option value="Event">Event</option>
                    <option value="Administrative">Administrative</option>
                    <option value="Charity">Charity</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expenseDescription">Description:</label>
                <textarea id="expenseDescription" placeholder="Enter expense description"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddExpenseModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddExpense()">Add Expense</button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h3>üì§ Export Data - Rangdhanu Charity Fund</h3>
            <div class="form-group">
                <label>Export Format:</label>
                <select id="exportFormat">
                    <option value="excel">Excel File (.xlsx)</option>
                    <option value="pdf">PDF Document</option>
                </select>
            </div>
            <div class="form-group">
                <label>Data to Export:</label>
                <select id="exportData">
                    <option value="all">Full Comprehensive Report (All Data)</option>
                    <option value="financial">Financial Summary (Collection/Expense)</option>
                    <option value="members">Detailed Member Payment Sheet</option>
                    <option value="donations">Public Donations Only</option>
                    <option value="expenses">Expenditure Records Only</option>
                    <option value="logs">Activity Logs</option>
                </select>
            </div>
            <div class="form-group" id="yearSelectionGroup" style="display: none;">
                <label>Select Year (for Member Sheet):</label>
                <select id="exportYearSelect"></select>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideExportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="exportData()">Export</button>
            </div>
        </div>
    </div>

    <div id="manageModal" class="modal">
        <div class="modal-content">
            <h3>‚öôÔ∏è System Management</h3>
            <div class="form-group">
                <button class="btn btn-primary" onclick="showBackupModal()" style="width: 100%; margin-bottom: 10px;">üíæ Backup Data</button>
                <button class="btn btn-primary" onclick="showRestoreModal()" style="width: 100%; margin-bottom: 10px;">üîÑ Restore Data</button>
                <button class="btn btn-secondary" onclick="logout()" style="width: 100%;">üö™ Logout</button>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideManageModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Member</h3>
            <div class="form-group">
                <label for="newMemberName">Member Name:</label>
                <input type="text" id="newMemberName" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label for="newMemberPhone">Phone Number:</label>
                <input type="text" id="newMemberPhone" placeholder="Optional">
            </div>
            <div class="form-group">
                <label for="newMemberEmail">Email Address:</label>
                <input type="email" id="newMemberEmail" placeholder="Optional">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddMemberModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddMember()">Add Member</button>
            </div>
        </div>
    </div>

    <div id="donationModal" class="modal">
        <div class="modal-content">
            <h3>+ Record New Public Donation</h3>
            <div class="form-group">
                <label for="donationDate">Date:</label>
                <input type="date" id="donationDate">
            </div>
            <div class="form-group">
                <label for="donorName">Donor Name:</label>
                <input type="text" id="donorName" placeholder="Enter donor name">
            </div>
            <div class="form-group">
                <label for="donationAmount">Amount (‡ß≥):</label>
                <input type="number" id="donationAmount" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label for="donationNote">Note (optional):</label>
                <textarea id="donationNote" placeholder="e.g. For food drive, Anonymous"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideDonationModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddDonation()">Record Donation</button>
            </div>
        </div>
    </div>

    <div id="manageMembersModal" class="modal">
        <div class="modal-content">
            <h3>üë• Manage Members</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Member Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Join Date</th>
                            <th>Total Paid</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="manageMembersBody"></tbody>
                </table>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideManageMembersModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="addYearModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Year</h3>
            <div class="form-group">
                <label for="newYear">Select Year:</label>
                <input type="number" id="newYear" min="2024" max="2030" value="2027">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddYearModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddYear()">Add Year</button>
            </div>
        </div>
    </div>

    <div id="manageYearsModal" class="modal">
        <div class="modal-content">
            <h3>üìÖ Manage Years</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Months</th>
                            <th>Total Collection</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="manageYearsBody"></tbody>
                </table>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideManageYearsModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="backupModal" class="modal">
        <div class="modal-content">
            <h3>üíæ Backup Data</h3>
            <div class="form-group">
                <p>Click the button below to create a backup of all data. This will save a copy to Firebase.</p>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideBackupModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createBackup()">Create Backup</button>
            </div>
        </div>
    </div>

    <div id="restoreModal" class="modal">
        <div class="modal-content">
            <h3>üîÑ Restore Data</h3>
            <div class="form-group">
                <p>Select a backup to restore from:</p>
                <select id="backupSelect">
                    <option value="">Loading backups...</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideRestoreModal()">Cancel</button>
                <button class="btn btn-primary" onclick="restoreBackup()">Restore</button>
            </div>
        </div>
    </div>

    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <h3 id="dialogTitle">Dialog</h3>
            <p id="dialogMessage" style="margin-bottom: 20px;"></p>
            <div class="form-actions">
                <button class="btn btn-secondary" id="dialogCancelBtn" style="display: none;">Cancel</button>
                <button class="btn btn-primary" id="dialogConfirmBtn">OK</button>
            </div>
        </div>
    </div>

	<div id="recycleBinModal" class="modal">
		<div class="modal-content" style="max-width: 900px;">
			<div class="recycle-bin-header">
				<div>
					<h3>üóëÔ∏è Recycle Bin</h3>
					<p class="recycle-bin-stats">Items will be permanently removed after 7 days</p>
				</div>
				<div class="recycle-bin-stats" id="recycleBinCount">0 items</div>
			</div>
			
			<div class="recycle-bin-filter-tabs" id="recycleFilterTabs">
				<button class="filter-tab active" onclick="filterRecycleBin('all')">All Items</button>
				<button class="filter-tab" onclick="filterRecycleBin('member')">Members</button>
				<button class="filter-tab" onclick="filterRecycleBin('year')">Years</button>
				<button class="filter-tab" onclick="filterRecycleBin('month')">Months</button>
				<button class="filter-tab" onclick="filterRecycleBin('donation')">Donations</button>
				<button class="filter-tab" onclick="filterRecycleBin('expense')">Expenses</button>
			</div>
			
			<div id="recycleBinContent" style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
				<!-- Recycle bin items will be populated here -->
			</div>
			<div class="form-actions">
				<button class="btn btn-secondary" onclick="hideRecycleBinModal()">Close</button>
				<button class="btn btn-danger admin-only" onclick="emptyRecycleBin()" id="emptyBinBtn">Empty Recycle Bin</button>
			</div>
		</div>
	</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Firebase Configuration - ACTUAL CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyDChxV-zUTEMK_Oe1xJVn123c8l7fonhDk",
          authDomain: "rangdhanu-1bdec.firebaseapp.com",
          projectId: "rangdhanu-1bdec",
          storageBucket: "rangdhanu-1bdec.firebasestorage.app",
          messagingSenderId: "842682768144",
          appId: "1:842682768144:web:ba7cdfbab05e0b7bd52395",
          measurementId: "G-P3YGK1TF48"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Enhanced data structure with Firebase integration
        let appData = {
            organization: "Rangdhanu Charity Fund",
            appVersion: "4.1",
            years: {}, // Initialize as empty, will be loaded from Firebase
            members: [], // Initialize as empty, will be loaded from Firebase
            payments: {}, // Initialize as empty, will be loaded from Firebase
            donations: [], // Initialize as empty, will be loaded from Firebase
            expenses: [], // Initialize as empty, will be loaded from Firebase
            activityLogs: [],
            recycleBin: [], // New: Store deleted items temporarily
            settings: {
                admins: {
                    "Ful Mia": "admin123",
                    "Shah Paran": "super123"
                },
                currentAdmin: null,
                isAuthenticated: false,
                adminContacts: [
                    { name: 'Admin 1', phone: '+8801712345678', email: 'admin1@rangdhanu.org' },
                    { name: 'Admin 2', phone: '+8801812345678', email: 'admin2@rangdhanu.org' }
                ]
            }
        };

        let monthlyChart, contributorsChart, financeChart;
        let isOnline = navigator.onLine;
        
        // Auto-logout variables
        let inactivityTimer;
        let logoutWarningTimer;
        let logoutCountdown = 300; // 5 minutes in seconds
        let logoutCountdownInterval;

        // ========== SEARCH AND SORT FUNCTIONALITY ==========

        function setupSearchFunctionality() {
            const searchInput = document.getElementById('memberSearch');
            searchInput.addEventListener('input', function() {
                filterMembers(this.value);
            });
            
            // ADDED: Setup search for reports tab
            const reportsSearchInput = document.getElementById('reportsSearch');
            reportsSearchInput.addEventListener('input', function() {
                filterReports(this.value);
            });
        }

        function filterMembers(searchTerm) {
            const filteredMembers = appData.members.filter(member => {
                const searchLower = searchTerm.toLowerCase();
                return (
                    member.name.toLowerCase().includes(searchLower) ||
                    (member.phone && member.phone.toLowerCase().includes(searchLower)) ||
                    (member.email && member.email.toLowerCase().includes(searchLower))
                );
            });
            
            // Update the display with filtered members
            renderYearsWithFilter(filteredMembers);
        }

        // ADDED: Filter function for reports
        function filterReports(searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            const filteredMembers = appData.members.filter(member => 
                member.name.toLowerCase().includes(searchLower)
            );
            
            updateReportsWithFilter(filteredMembers);
        }

        // ADDED: Update reports with filtered members
        function updateReportsWithFilter(filteredMembers) {
            const contributionSummary = document.getElementById('contributionSummary');
            contributionSummary.innerHTML = '';
            
            filteredMembers.forEach(member => {
                const total = Object.keys(appData.years).reduce((sum, year) => 
                    sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                
                let monthsPaid = 0;
                let totalMonths = 0;
                
                Object.keys(appData.years).forEach(year => {
                    const yearPayments = appData.payments[member.id]?.[year] || [];
                    monthsPaid += yearPayments.filter(val => val !== null && parseFloat(val) > 0).length;
                    totalMonths += yearPayments.length;
                });
                
                const monthsDue = totalMonths - monthsPaid;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${member.name}</strong></td>
                    <td><span class="taka-symbol">‡ß≥</span>${total.toFixed(2)}</td>
                    <td>${monthsPaid}</td>
                    <td>${monthsDue}</td>
                    <td class="admin-only">
                        <button class="delete-btn" onclick="deleteMemberConfirmation(${member.id})">Delete</button>
                    </td>
                `;
                contributionSummary.appendChild(row);
            });
        }

        // ADDED: Sort function for reports
        function sortReports() {
            const sortBy = document.getElementById('sortReports').value;
            let sortedMembers = [...appData.members];
            
            switch(sortBy) {
                case 'name':
                    sortedMembers.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    sortedMembers.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'total-paid':
                    sortedMembers.sort((a, b) => {
                        const aTotal = Object.keys(appData.years).reduce((sum, year) => 
                            sum + (appData.payments[a.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                        const bTotal = Object.keys(appData.years).reduce((sum, year) => 
                            sum + (appData.payments[b.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                        return bTotal - aTotal;
                    });
                    break;
                case 'total-paid-asc':
                    sortedMembers.sort((a, b) => {
                        const aTotal = Object.keys(appData.years).reduce((sum, year) => 
                            sum + (appData.payments[a.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                        const bTotal = Object.keys(appData.years).reduce((sum, year) => 
                            sum + (appData.payments[b.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                        return aTotal - bTotal;
                    });
                    break;
                case 'months-paid':
                    sortedMembers.sort((a, b) => {
                        let aMonthsPaid = 0;
                        let bMonthsPaid = 0;
                        
                        Object.keys(appData.years).forEach(year => {
                            const aYearPayments = appData.payments[a.id]?.[year] || [];
                            const bYearPayments = appData.payments[b.id]?.[year] || [];
                            aMonthsPaid += aYearPayments.filter(val => val !== null && parseFloat(val) > 0).length;
                            bMonthsPaid += bYearPayments.filter(val => val !== null && parseFloat(val) > 0).length;
                        });
                        
                        return bMonthsPaid - aMonthsPaid;
                    });
                    break;
                case 'months-due':
                    sortedMembers.sort((a, b) => {
                        let aMonthsDue = 0;
                        let bMonthsDue = 0;
                        
                        Object.keys(appData.years).forEach(year => {
                            const aYearPayments = appData.payments[a.id]?.[year] || [];
                            const bYearPayments = appData.payments[b.id]?.[year] || [];
                            aMonthsDue += aYearPayments.filter(val => val === null || parseFloat(val) <= 0).length;
                            bMonthsDue += bYearPayments.filter(val => val === null || parseFloat(val) <= 0).length;
                        });
                        
                        return bMonthsDue - aMonthsDue;
                    });
                    break;
            }
            
            // Update the display with sorted members
            const searchTerm = document.getElementById('reportsSearch').value;
            if (searchTerm) {
                const filteredMembers = sortedMembers.filter(member => {
                    const searchLower = searchTerm.toLowerCase();
                    return member.name.toLowerCase().includes(searchLower);
                });
                updateReportsWithFilter(filteredMembers);
            } else {
                updateReportsWithFilter(sortedMembers);
            }
        }

        function renderYearsWithFilter(filteredMembers) {
            const container = document.getElementById('yearsContainer');
            container.innerHTML = '';
            
            Object.keys(appData.years).sort().forEach(year => {
                const yearData = appData.years[year];
                const yearSection = document.createElement('div');
                yearSection.className = 'year-section';

                yearSection.innerHTML = `
                    <div class="year-header">
                        <div class="year-title">
                            ${year} - Rangdhanu Charity Fund
                            ${appData.settings.isAuthenticated ? 
                                `<button class="delete-btn admin-only" onclick="deleteYearConfirmation('${year}')">Delete Year</button>` : 
                                ''}
                        </div>
                        <div class="year-actions">
                            <button class="toggle-btn" onclick="toggleYear('${year}')">‚ñº</button>
                        </div>
                    </div>
                    <div id="year-${year}" class="collapsible">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr id="header-${year}"></tr>
                                </thead>
                                <tbody id="body-${year}"></tbody>
                                <tfoot>
                                    <tr id="total-${year}" style="font-weight: bold; background: #f8f9fa;"></tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(yearSection);
                renderYearTableWithFilter(year, filteredMembers);
            });
        }

        function renderYearTableWithFilter(year, filteredMembers) {
            const headerRow = document.getElementById(`header-${year}`);
            const tableBody = document.getElementById(`body-${year}`);
            const totalRow = document.getElementById(`total-${year}`);
            const yearData = appData.years[year];

            headerRow.innerHTML = '<th>Member Name</th>';
            yearData.months.forEach((month, index) => {
                headerRow.innerHTML += `
                    <th>
                        <div class="month-header">
                            ${month}
                            ${appData.settings.isAuthenticated ? `<button class="delete-btn admin-only" onclick="deleteMonthConfirmation('${year}', ${index})">√ó</button>` : ''}
                        </div>
                    </th>`;
            });
            headerRow.innerHTML += '<th>Total</th>';

            tableBody.innerHTML = '';
            filteredMembers.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `<td><strong>${member.name}</strong></td>`;
                
                yearData.months.forEach((month, mIdx) => {
                    const payment = appData.payments[member.id]?.[year]?.[mIdx];
                    const cellClass = payment ? 'cell-green' : getCellClass(year, mIdx);
                    row.innerHTML += `
                        <td class="${cellClass}">
                            <input type="number" value="${payment || ''}" 
                                            onchange="updatePayment(${member.id}, '${year}', ${mIdx}, this.value)"
                                            placeholder="0" ${!appData.settings.isAuthenticated ? 'disabled' : ''}>
                        </td>`;
                });

                const total = (appData.payments[member.id]?.[year] || []).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
                row.innerHTML += `<td><strong><span class="taka-symbol">‡ß≥</span>${total.toFixed(2)}</strong></td>`;
                tableBody.appendChild(row);
            });

            totalRow.innerHTML = '<td>Monthly Total</td>';
            yearData.months.forEach((month, mIdx) => {
                const monthTotal = filteredMembers.reduce((sum, member) => 
                    sum + (parseFloat(appData.payments[member.id]?.[year]?.[mIdx]) || 0), 0);
                totalRow.innerHTML += `<td><span class="taka-symbol">‡ß≥</span>${monthTotal.toFixed(2)}</td>`;
            });

            const grandTotal = filteredMembers.reduce((sum, member) => 
                sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
            totalRow.innerHTML += `<td><span class="taka-symbol">‡ß≥</span>${grandTotal.toFixed(2)}</td>`;
        }

        function sortMembers() {
            const sortBy = document.getElementById('sortMembers').value;
            let sortedMembers = [...appData.members];
            
            switch(sortBy) {
                case 'name':
                    sortedMembers.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    sortedMembers.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'current-payment':
                    // Sort by current month payment status
                    sortedMembers.sort((a, b) => {
                        const today = new Date();
                        let aCurrentPayment = 0;
                        let bCurrentPayment = 0;
                        
                        Object.keys(appData.years).sort().forEach(year => {
                            const yearData = appData.years[year];
                            yearData.monthDates.forEach((monthDateString, index) => {
                                const monthDate = new Date(monthDateString);
                                const nextMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 1);
                                
                                if (today >= monthDate && today < nextMonth) {
                                    aCurrentPayment = parseFloat(appData.payments[a.id]?.[year]?.[index]) || 0;
                                    bCurrentPayment = parseFloat(appData.payments[b.id]?.[year]?.[index]) || 0;
                                }
                            });
                        });
                        
                        return bCurrentPayment - aCurrentPayment;
                    });
                    break;
                case 'total-payment':
                    // Sort by total payment amount
                    sortedMembers.sort((a, b) => {
                        const aTotal = Object.keys(appData.years).reduce((sum, year) => 
                            sum + (appData.payments[a.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                        const bTotal = Object.keys(appData.years).reduce((sum, year) => 
                            sum + (appData.payments[b.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                        return bTotal - aTotal;
                    });
                    break;
            }
            
            // Update the display with sorted members
            const searchTerm = document.getElementById('memberSearch').value;
            if (searchTerm) {
                const filteredMembers = sortedMembers.filter(member => {
                    const searchLower = searchTerm.toLowerCase();
                    return (
                        member.name.toLowerCase().includes(searchLower) ||
                        (member.phone && member.phone.toLowerCase().includes(searchLower)) ||
                        (member.email && member.email.toLowerCase().includes(searchLower))
                    );
                });
                renderYearsWithFilter(filteredMembers);
            } else {
                renderYearsWithFilter(sortedMembers);
            }
        }
		
		// ========== RECYCLE BIN FUNCTIONALITY ==========

		let currentRecycleFilter = 'all';

		function showRecycleBinModal() {
			if (!requireAuth()) return;
			document.getElementById('recycleBinModal').style.display = 'flex';
			currentRecycleFilter = 'all';
			renderRecycleBin();
		}

		function hideRecycleBinModal() {
			document.getElementById('recycleBinModal').style.display = 'none';
			currentRecycleFilter = 'all';
		}

		function filterRecycleBin(type) {
			currentRecycleFilter = type;
			
			// Update active tab
			document.querySelectorAll('.filter-tab').forEach(tab => {
				tab.classList.remove('active');
			});
			event.target.classList.add('active');
			
			renderRecycleBin();
		}

		function renderRecycleBin() {
			const recycleBinContent = document.getElementById('recycleBinContent');
			
			// Show loading state
			recycleBinContent.innerHTML = '<div class="recycle-bin-loading">‚è≥ Loading recycle bin...</div>';
			
			// Use setTimeout to ensure UI updates before heavy processing
			setTimeout(() => {
				try {
					// Filter items based on current filter
					let filteredItems = currentRecycleFilter === 'all' 
						? appData.recycleBin 
						: appData.recycleBin.filter(item => item.type === currentRecycleFilter);
					
					// Update count
					document.getElementById('recycleBinCount').textContent = 
						`${filteredItems.length} item${filteredItems.length !== 1 ? 's' : ''}`;
					
					// Update empty bin button
					const emptyBtn = document.getElementById('emptyBinBtn');
					if (appData.recycleBin.length === 0) {
						emptyBtn.disabled = true;
						emptyBtn.style.opacity = '0.5';
					} else {
						emptyBtn.disabled = false;
						emptyBtn.style.opacity = '1';
					}
					
					if (filteredItems.length === 0) {
						recycleBinContent.innerHTML = '<div class="recycle-bin-empty">üóëÔ∏è No items in recycle bin</div>';
						return;
					}
					
					// Sort by deletion date (newest first)
					const sortedBin = [...filteredItems].sort((a, b) => 
						new Date(b.deletedAt) - new Date(a.deletedAt)
					);
					
					// Group items by type for better organization
					const groupedItems = {
						member: [],
						year: [],
						month: [],
						donation: [],
						expense: []
					};
					
					sortedBin.forEach(item => {
						if (groupedItems[item.type]) {
							groupedItems[item.type].push(item);
						}
					});
					
					let htmlContent = '';
					
					// Render each section
					Object.keys(groupedItems).forEach(type => {
						if (groupedItems[type].length > 0) {
							let sectionTitle = '';
							switch(type) {
								case 'member': sectionTitle = 'üë§ Members'; break;
								case 'year': sectionTitle = 'üìÖ Years'; break;
								case 'month': sectionTitle = 'üìÜ Months'; break;
								case 'donation': sectionTitle = 'üíù Donations'; break;
								case 'expense': sectionTitle = 'üí∏ Expenses'; break;
							}
							
							htmlContent += `<div class="recycle-bin-section">
								<div class="recycle-bin-section-title">
									<span>${sectionTitle}</span>
									<span class="section-count">${groupedItems[type].length}</span>
								</div>`;
							
							groupedItems[type].forEach((item) => {
								const daysLeft = Math.ceil((7 - (Date.now() - new Date(item.deletedAt).getTime()) / (1000 * 60 * 60 * 24)));
								const isExpired = daysLeft <= 0;
								const isWarning = daysLeft > 0 && daysLeft <= 2;
								
								let details = '';
								let typeBadge = '';
								let itemName = '';
								
								switch(item.type) {
									case 'member':
										typeBadge = 'member-type-badge';
										itemName = item.data.name;
										details = `üìû ${item.data.phone || 'N/A'} | üìß ${item.data.email || 'N/A'}`;
										break;
									case 'year':
										typeBadge = 'year-type-badge';
										itemName = item.data.year;
										details = `üìä ${item.data.months.length} months | üí∞ Total: ‡ß≥${calculateYearTotal(item.data.year)}`;
										break;
									case 'month':
										typeBadge = 'month-type-badge';
										itemName = item.data.monthName;
										details = `üìÖ Year: ${item.data.year}`;
										break;
									case 'donation':
										typeBadge = 'donation-type-badge';
										itemName = item.data.name;
										details = `üí∞ Amount: ‡ß≥${item.data.amount.toFixed(2)} | üìÖ ${item.data.date}`;
										break;
									case 'expense':
										typeBadge = 'expense-type-badge';
										itemName = item.data.description;
										details = `üí∞ Amount: ‡ß≥${item.data.amount.toFixed(2)} | üè∑Ô∏è ${item.data.category} | üìÖ ${item.data.date}`;
										break;
								}
								
								// Find the actual index in the original recycle bin array
								const actualIndex = appData.recycleBin.findIndex(binItem => 
									binItem.type === item.type && 
									binItem.deletedAt === item.deletedAt && 
									binItem.deletedBy === item.deletedBy &&
									JSON.stringify(binItem.data) === JSON.stringify(item.data)
								);
								
								const daysLeftClass = isExpired ? 'expired' : (isWarning ? 'warning' : '');
								const daysLeftText = isExpired ? '‚ö†Ô∏è Expired' : `‚è±Ô∏è ${daysLeft} day${daysLeft !== 1 ? 's' : ''} left`;
								
								htmlContent += `
									<div class="recycle-bin-item ${isExpired ? 'expired' : ''} ${type}-type">
										<div class="recycle-bin-item-info">
											<div>
												<span class="recycle-bin-item-type ${typeBadge}">${item.type.toUpperCase()}</span>
												<span class="days-left ${daysLeftClass}">${daysLeftText}</span>
											</div>
											<div class="recycle-bin-item-name">${itemName}</div>
											<div class="recycle-bin-item-details">${details}</div>
											<div class="recycle-bin-item-details" style="margin-top: 5px;">
												üóëÔ∏è Deleted by <strong>${item.deletedBy}</strong> on ${new Date(item.deletedAt).toLocaleString()}
											</div>
										</div>
										<div class="recycle-bin-item-actions">
											<button class="recycle-bin-restore-btn" onclick="restoreFromRecycleBin(${actualIndex})" ${isExpired ? 'disabled' : ''}>
												‚ôªÔ∏è Restore
											</button>
											<button class="recycle-bin-delete-btn" onclick="permanentlyDeleteFromRecycleBin(${actualIndex})">
												üóëÔ∏è Delete
											</button>
										</div>
									</div>
								`;
							});
							
							htmlContent += `</div>`;
						}
					});
					
					recycleBinContent.innerHTML = htmlContent;
				} catch (error) {
					console.error('Error rendering recycle bin:', error);
					recycleBinContent.innerHTML = '<div class="recycle-bin-empty">‚ùå Error loading recycle bin content.</div>';
				}
			}, 50);
		}

		function calculateYearTotal(year) {
			let total = 0;
			appData.members.forEach(member => {
				total += (appData.payments[member.id]?.[year] || []).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
			});
			return total.toFixed(2);
		}

		function addToRecycleBin(type, data, deletedBy) {
			const recycleItem = {
				type: type,
				data: data,
				deletedBy: deletedBy,
				deletedAt: new Date().toISOString()
			};
			
			appData.recycleBin.push(recycleItem);
			
			// Save to Firebase
			if (isOnline) {
				try {
					db.collection('recycleBin').add(recycleItem);
				} catch (error) {
					console.error('Error saving to recycle bin:', error);
				}
			}
		}

		async function restoreFromRecycleBin(index) {
			if (index < 0 || index >= appData.recycleBin.length) {
				showCustomAlert('‚ùå Invalid item selected for restoration!', 'Restore Error', 'danger');
				return;
			}
			
			const item = appData.recycleBin[index];
			
			// Check if item is expired
			const daysLeft = Math.ceil((7 - (Date.now() - new Date(item.deletedAt).getTime()) / (1000 * 60 * 60 * 24)));
			if (daysLeft <= 0) {
				showCustomAlert('‚ùå This item has expired and cannot be restored!', 'Restore Error', 'danger');
				return;
			}
			
			showCustomConfirm(
				`Are you sure you want to restore this ${item.type}: ${item.data.name || item.data.year || item.data.description || 'item'}?`,
				'Confirm Restore',
				'primary',
				async (confirmed) => {
					if (confirmed) {
						try {
							showLoading('Restoring item...');
							
							let success = false;
							let errorMessage = '';
							
							switch(item.type) {
								case 'member':
									const existingMember = appData.members.find(m => m.id === item.data.id);
									if (existingMember) {
										errorMessage = 'A member with the same ID already exists!';
										break;
									}
									
									appData.members.push(item.data);
									await saveMember(item.data);
									
									if (item.data.payments) {
										Object.keys(item.data.payments).forEach(year => {
											appData.payments[item.data.id] = appData.payments[item.data.id] || {};
											appData.payments[item.data.id][year] = item.data.payments[year];
											savePayment(item.data.id, year, item.data.payments[year]);
										});
									}
									success = true;
									break;
									
								case 'year':
									if (appData.years[item.data.year]) {
										errorMessage = 'This year already exists!';
										break;
									}
									
									appData.years[item.data.year] = {
										months: item.data.months,
										monthDates: item.data.monthDates
									};
									await saveYear(item.data.year, appData.years[item.data.year]);
									success = true;
									break;
									
								case 'month':
									errorMessage = 'Month restoration is not supported.';
									break;
									
								case 'donation':
									const existingDonation = appData.donations.find(d => 
										d.date === item.data.date && 
										d.name === item.data.name && 
										d.amount === item.data.amount
									);
									
									if (!existingDonation) {
										appData.donations.push(item.data);
										await saveDonation(item.data);
										success = true;
									} else {
										errorMessage = 'A donation with the same details already exists!';
									}
									break;
									
								case 'expense':
									const existingExpense = appData.expenses.find(e => 
										e.date === item.data.date && 
										e.amount === item.data.amount && 
										e.description === item.data.description
									);
									
									if (!existingExpense) {
										appData.expenses.push(item.data);
										await saveExpense(item.data);
										success = true;
									} else {
										errorMessage = 'An expense with the same details already exists!';
									}
									break;
							}
							
							if (success) {
								// Remove from recycle bin
								appData.recycleBin.splice(index, 1);
								
								// Delete from Firebase recycle bin
								if (isOnline) {
									try {
										const snapshot = await db.collection('recycleBin')
											.where('deletedAt', '==', item.deletedAt)
											.where('deletedBy', '==', item.deletedBy)
											.get();
										
										snapshot.forEach(doc => {
											if (doc.data().type === item.type && 
												JSON.stringify(doc.data().data) === JSON.stringify(item.data)) {
												doc.ref.delete();
											}
										});
									} catch (error) {
										console.error('Error removing from Firebase recycle bin:', error);
									}
								}
								
								// Re-render everything
								renderYears();
								renderDonations();
								renderExpenses();
								updateDashboard();
								updateReports();
								updateFinance();
								renderRecycleBin();
								
								hideLoading();
								showCustomAlert('‚úÖ Item restored successfully!', 'Restore Success', 'success');
								logActivity('restored from recycle bin', `Restored ${item.type}: ${item.data.name || item.data.year || 'N/A'}`);
							} else {
								hideLoading();
								showCustomAlert(`‚ùå ${errorMessage}`, 'Restore Error', 'danger');
							}
							
						} catch (error) {
							hideLoading();
							showCustomAlert('‚ùå Error restoring item: ' + error.message, 'Restore Error', 'danger');
						}
					}
				}
			);
		}

		async function permanentlyDeleteFromRecycleBin(index) {
			if (index < 0 || index >= appData.recycleBin.length) {
				showCustomAlert('‚ùå Invalid item selected for deletion!', 'Deletion Error', 'danger');
				return;
			}
			
			const item = appData.recycleBin[index];
			const itemName = item.data.name || item.data.year || item.data.description || 'this item';
			
			showCustomConfirm(
				`Are you sure you want to permanently delete this ${item.type}: ${itemName}? This action cannot be undone!`,
				'Confirm Permanent Deletion',
				'danger',
				async (confirmed) => {
					if (confirmed) {
						try {
							showLoading('Deleting item permanently...');
							
							// Remove from recycle bin
							const deletedItem = appData.recycleBin.splice(index, 1)[0];
							
							// Delete from Firebase recycle bin
							if (isOnline) {
								try {
									const snapshot = await db.collection('recycleBin')
										.where('deletedAt', '==', deletedItem.deletedAt)
										.where('deletedBy', '==', deletedItem.deletedBy)
										.get();
									
									snapshot.forEach(doc => {
										if (doc.data().type === deletedItem.type && 
											JSON.stringify(doc.data().data) === JSON.stringify(deletedItem.data)) {
											doc.ref.delete();
										}
									});
								} catch (error) {
									console.error('Error removing from Firebase recycle bin:', error);
								}
							}
							
							renderRecycleBin();
							hideLoading();
							showCustomAlert('‚úÖ Item permanently deleted!', 'Deletion Success', 'success');
							logActivity('permanently deleted from recycle bin', `Permanently deleted ${deletedItem.type}: ${itemName}`);
						} catch (error) {
							hideLoading();
							showCustomAlert('‚ùå Error deleting item: ' + error.message, 'Deletion Error', 'danger');
						}
					}
				}
			);
		}

		function emptyRecycleBin() {
			if (appData.recycleBin.length === 0) {
				showCustomAlert('‚ÑπÔ∏è Recycle bin is already empty!', 'Empty Bin', 'warning');
				return;
			}
			
			showCustomConfirm(
				`‚ö†Ô∏è Are you sure you want to empty the entire recycle bin? All ${appData.recycleBin.length} item(s) will be permanently deleted!`,
				'Confirm Empty Recycle Bin',
				'danger',
				async (confirmed) => {
					if (confirmed) {
						try {
							showLoading('Emptying recycle bin...');
							
							const itemCount = appData.recycleBin.length;
							
							// Delete all from Firebase
							if (isOnline) {
								const snapshot = await db.collection('recycleBin').get();
								const batch = db.batch();
								snapshot.docs.forEach(doc => {
									batch.delete(doc.ref);
								});
								await batch.commit();
							}
							
							// Clear local recycle bin
							appData.recycleBin = [];
							
							renderRecycleBin();
							hideLoading();
							showCustomAlert(`‚úÖ Successfully deleted ${itemCount} item(s) from recycle bin!`, 'Recycle Bin Emptied', 'success');
							logActivity('emptied recycle bin', `Emptied the entire recycle bin (${itemCount} items)`);
						} catch (error) {
							hideLoading();
							showCustomAlert('‚ùå Error emptying recycle bin: ' + error.message, 'Error', 'danger');
						}
					}
				}
			);
		}

		function cleanupExpiredItems() {
			const now = new Date();
			const expiredItems = appData.recycleBin.filter(item => {
				const deletedAt = new Date(item.deletedAt);
				const daysSinceDeletion = (now - deletedAt) / (1000 * 60 * 60 * 24);
				return daysSinceDeletion >= 7;
			});
			
			if (expiredItems.length > 0) {
				// Remove expired items from local array
				appData.recycleBin = appData.recycleBin.filter(item => {
					const deletedAt = new Date(item.deletedAt);
					const daysSinceDeletion = (now - deletedAt) / (1000 * 60 * 60 * 24);
					return daysSinceDeletion < 7;
				});
				
				// Remove from Firebase
				if (isOnline) {
					expiredItems.forEach(item => {
						db.collection('recycleBin')
							.where('deletedAt', '==', item.deletedAt)
							.where('deletedBy', '==', item.deletedBy)
							.get()
							.then(snapshot => {
								snapshot.forEach(doc => {
									if (doc.data().type === item.type && 
										JSON.stringify(doc.data().data) === JSON.stringify(item.data)) {
										doc.ref.delete();
									}
								});
							})
							.catch(error => {
								console.error('Error removing expired item from Firebase:', error);
							});
					});
				}
				
				if (document.getElementById('recycleBinModal').style.display === 'flex') {
					renderRecycleBin();
				}
			}
		}

        // ========== AUTO-LOGOUT FUNCTIONALITY ==========

        function resetInactivityTimer() {
            // Clear existing timers
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            clearInterval(logoutCountdownInterval);
            
            // Hide warning if visible
            document.getElementById('logoutWarning').style.display = 'none';
            
            // Only set timers if admin is logged in
            if (appData.settings.isAuthenticated) {
                // Set warning timer (4 minutes)
                logoutWarningTimer = setTimeout(showLogoutWarning, 4 * 60 * 1000);
                
                // Set logout timer (5 minutes)
                inactivityTimer = setTimeout(logout, 5 * 60 * 1000);
            }
        }

        function showLogoutWarning() {
            // Show warning modal
            document.getElementById('logoutWarning').style.display = 'block';
            
            // Start countdown
            logoutCountdown = 60; // 1 minute countdown
            document.getElementById('logoutCountdown').textContent = formatTime(logoutCountdown);
            
            logoutCountdownInterval = setInterval(function() {
                logoutCountdown--;
                document.getElementById('logoutCountdown').textContent = formatTime(logoutCountdown);
                
                if (logoutCountdown <= 0) {
                    clearInterval(logoutCountdownInterval);
                    logout();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function continueSession() {
            resetInactivityTimer();
        }

        // Set up activity listeners
        function setupActivityListeners() {
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
        }

        // ========== FIREBASE DATA MANAGEMENT ==========

        async function initializeFirebase() {
            showLoading('Connecting to database...');
            try {
                // Load settings first (no need to await, it's small)
                const settingsDoc = await db.collection('settings').doc('appSettings').get();
                if (settingsDoc.exists) {
                    const settingsData = settingsDoc.data();
                    appData.settings = { ...appData.settings, ...settingsData };
                }

                // Load all other data
                await loadAllData();
                
                // Initialize the rest of the app only after ALL data is loaded
                initializePayments();
                renderYears();
                renderDonations();
                renderExpenses();
                updateDashboard();
                updateReports();
                updateFinance();
                updateDateRange();
                updateLoginStatus();
                updateAdminControls();
                
                // Setup search functionality
                setupSearchFunctionality();

                hideLoading();
                showSyncStatus('Connected to cloud database!', 'success');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                hideLoading();
                // Fallback rendering even if data load failed (it will be empty or use defaults)
                renderYears();
                renderDonations();
                renderExpenses();
                updateDashboard();
                updateReports();
                updateFinance();
                updateDateRange();
                updateLoginStatus();
                updateAdminControls();
                
                // Setup search functionality even in offline mode
                setupSearchFunctionality();

                showCustomAlert('‚ùå Could not load all data from Firebase. Check console for details.', 'Database Error', 'danger');
                showSyncStatus('Using initial offline data', 'error');
            }
        }

        async function loadAllData() {
            try {
                // Use Promise.all to fetch all collections concurrently
                const [
                    yearsSnapshot,
                    membersSnapshot,
                    paymentsSnapshot,
                    donationsSnapshot,
                    expensesSnapshot,
                    logsSnapshot,
                    recycleBinSnapshot
                ] = await Promise.all([
                    db.collection('years').get(),
                    db.collection('members').get(),
                    db.collection('payments').get(),
                    db.collection('donations').get(),
                    db.collection('expenses').get(),
                    db.collection('activityLogs').orderBy('timestamp', 'desc').limit(1000).get(),
                    db.collection('recycleBin').get()
                ]);

                // Process years
                appData.years = {};
                if (!yearsSnapshot.empty) {
                    yearsSnapshot.forEach(doc => {
                        appData.years[doc.id] = doc.data();
                    });
                }

                // Process members - important to sort by ID for consistent rendering
                appData.members = [];
                if (!membersSnapshot.empty) {
                    membersSnapshot.forEach(doc => {
                        appData.members.push({ id: parseInt(doc.id), ...doc.data() });
                    });
                    appData.members.sort((a, b) => a.id - b.id);
                }

                // Process payments
                appData.payments = {};
                if (!paymentsSnapshot.empty) {
                    paymentsSnapshot.forEach(doc => {
                        appData.payments[doc.id] = doc.data();
                    });
                }

                // Process donations
                appData.donations = [];
                if (!donationsSnapshot.empty) {
                    donationsSnapshot.forEach(doc => {
                        appData.donations.push({ id: doc.id, ...doc.data() });
                    });
                }

                // Process expenses
                appData.expenses = [];
                if (!expensesSnapshot.empty) {
                    expensesSnapshot.forEach(doc => {
                        appData.expenses.push({ id: doc.id, ...doc.data() });
                    });
                }

                // Process activity logs - limit to 100 entries
                appData.activityLogs = [];
                if (!logsSnapshot.empty) {
                    logsSnapshot.forEach(doc => {
                        appData.activityLogs.push(doc.data());
                    });
                    
                    // Keep only the latest 100 logs
                    if (appData.activityLogs.length > 100) {
                        appData.activityLogs = appData.activityLogs.slice(0, 100);
                    }
                }
                
                // Process recycle bin
                appData.recycleBin = [];
                if (!recycleBinSnapshot.empty) {
                    recycleBinSnapshot.forEach(doc => {
                        appData.recycleBin.push(doc.data());
                    });
                    
                    // Clean up expired items on load
                    cleanupExpiredItems();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                throw error;
            }
        }

        async function saveData() {
            if (!isOnline) {
                showSyncStatus('Offline - changes will sync when online', 'pending');
                return;
            }

            try {
                showSyncStatus('Saving settings to cloud...', 'pending');
                
                // Save settings
                await db.collection('settings').doc('appSettings').set(appData.settings, { merge: true });

                showSyncStatus('Settings saved to cloud!', 'success');
            } catch (error) {
                console.error('Error saving data:', error);
                showSyncStatus('Error saving to cloud', 'error');
            }
        }

        // Individual save functions for better performance
        async function saveMember(member) {
            if (!isOnline) return;
            try {
                // Ensure member.id is treated as a string for the Document ID
                await db.collection('members').doc(member.id.toString()).set(member, { merge: true });
            } catch (error) {
                console.error('Error saving member:', error);
            }
        }

        async function savePayment(memberId, year, payments) {
            if (!isOnline) return;
            try {
                // Sets the specific year array within the member's payments document
                await db.collection('payments').doc(memberId.toString()).set({
                    [year]: payments
                }, { merge: true });
            } catch (error) {
                console.error('Error saving payment:', error);
            }
        }

        async function saveDonation(donation) {
            if (!isOnline) return;
            try {
                const docData = { ...donation };
                delete docData.id; // Ensure we don't save the id field inside the document itself if it's new

                // If donation.id exists, update the existing document, otherwise create a new one
                const docRef = donation.id
                    ? db.collection('donations').doc(donation.id)
                    : db.collection('donations').doc();

                await docRef.set(docData, { merge: true });
                return docRef.id;
            } catch (error) {
                console.error('Error saving donation:', error);
            }
        }

        async function saveExpense(expense) {
            if (!isOnline) return;
            try {
                const docData = { ...expense };
                delete docData.id; // Ensure we don't save the id field inside the document itself if it's new

                // If expense.id exists, update the existing document, otherwise create a new one
                const docRef = expense.id
                    ? db.collection('expenses').doc(expense.id)
                    : db.collection('expenses').doc();

                await docRef.set(docData, { merge: true });
                return docRef.id;
            } catch (error) {
                console.error('Error saving expense:', error);
            }
        }

        async function saveYear(year, yearData) {
            if (!isOnline) return;
            try {
                const serializableData = {
                    months: yearData.months,
                    // Ensure monthDates are saved as ISO strings
                    monthDates: yearData.monthDates.map(d => d instanceof Date ? d.toISOString() : d) 
                };
                await db.collection('years').doc(year).set(serializableData, { merge: true });
            } catch (error) {
                console.error('Error saving year:', error);
            }
        }

        async function logActivity(action, details) {
            if (!appData.settings.isAuthenticated || !appData.settings.currentAdmin) return;
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                admin: appData.settings.currentAdmin,
                action: action,
                details: details
            };
            
            // Add to in-memory array (unshift for newest first)
            appData.activityLogs.unshift(logEntry);
            
            // Keep only last 100 logs
            if (appData.activityLogs.length > 100) {
                appData.activityLogs = appData.activityLogs.slice(0, 100);
            }
            
            // Save to Firebase
            if (isOnline) {
                try {
                    // Use .add() for a new, timestamped log entry
                    await db.collection('activityLogs').add(logEntry);
                } catch (error) {
                    console.error('Error saving activity log:', error);
                }
            }
            
            if (document.getElementById('logs').classList.contains('active')) {
                renderActivityLogs();
            }
        }

        // ========== CUSTOM DIALOG MANAGEMENT ==========

        function hideCustomDialogModal() {
            document.getElementById('customDialogModal').style.display = 'none';
        }

        function showCustomAlert(message, title = 'Notification', type = 'primary') {
            const modal = document.getElementById('customDialogModal');
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogMessage').textContent = message;
            
            const confirmBtn = document.getElementById('dialogConfirmBtn');
            const cancelBtn = document.getElementById('dialogCancelBtn');

            confirmBtn.textContent = 'OK';
            confirmBtn.className = `btn btn-${type}`;
            confirmBtn.onclick = hideCustomDialogModal;

            cancelBtn.style.display = 'none';
            modal.style.display = 'flex';
        }

        function showCustomConfirm(message, title = 'Confirmation', type = 'danger', callback) {
            const modal = document.getElementById('customDialogModal');
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogMessage').textContent = message;
            
            const confirmBtn = document.getElementById('dialogConfirmBtn');
            const cancelBtn = document.getElementById('dialogCancelBtn');

            confirmBtn.textContent = 'Confirm';
            confirmBtn.className = `btn btn-${type}`;
            confirmBtn.onclick = () => {
                hideCustomDialogModal();
                callback(true);
            };

            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.onclick = () => {
                hideCustomDialogModal();
                callback(false);
            };
            cancelBtn.style.display = 'inline-flex';
            modal.style.display = 'flex';
        }

        // ========== NETWORK STATUS HANDLING ==========

        function handleOnline() {
            isOnline = true;
            showSyncStatus('Back online - syncing data...', 'pending');
            // Re-initialize to reload data which might have been changed while offline
            initializeFirebase(); 
        }

        function handleOffline() {
            isOnline = false;
            showSyncStatus('You are offline - changes saved locally', 'error');
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status sync-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        function showLoading(message) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ========== AUTHENTICATION FUNCTIONS ==========

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('adminName').value = '';
            document.getElementById('adminPassword').value = '';
        }

        function login() {
            const adminName = document.getElementById('adminName').value.trim();
            const password = document.getElementById('adminPassword').value;
            
            if (!adminName) {
                showCustomAlert('‚ùå Please enter your name!', 'Login Error', 'warning');
                return;
            }
            
            if (appData.settings.admins[adminName] && password === appData.settings.admins[adminName]) {
                appData.settings.isAuthenticated = true;
                appData.settings.currentAdmin = adminName;
                hideLoginModal();
                updateLoginStatus();
                updateAdminControls();
                renderYears();
                
                // Reset inactivity timer on login
                resetInactivityTimer();
                
                logActivity('logged in', `Admin ${adminName} logged into the system`);
                
                showCustomAlert('‚úÖ Admin access granted!', 'Success', 'success');
            } else {
                showCustomAlert('‚ùå Invalid username or password!', 'Login Error', 'danger');
            }
        }

        function logout() {
            const adminName = appData.settings.currentAdmin;
            appData.settings.isAuthenticated = false;
            appData.settings.currentAdmin = null;
            updateLoginStatus();
            updateAdminControls();
            renderYears();
            hideManageModal();
            
            // Clear inactivity timers
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            clearInterval(logoutCountdownInterval);
            document.getElementById('logoutWarning').style.display = 'none';
            
            if (adminName) {
                logActivity('logged out', `Admin ${adminName} logged out of the system`);
            }
            
            showCustomAlert('‚úÖ Logged out successfully!', 'Success', 'success');
        }

        function updateLoginStatus() {
            const statusElement = document.getElementById('loginStatus');
            const loginBtn = document.getElementById('loginBtn');
            
            if (appData.settings.isAuthenticated) {
                statusElement.textContent = `Logged in as ${appData.settings.currentAdmin}`;
                statusElement.className = 'status-badge status-logged-in';
                loginBtn.textContent = 'üö™ Logout';
                loginBtn.onclick = logout;
                document.body.classList.add('admin-logged-in');
            } else {
                statusElement.textContent = 'Logged Out';
                statusElement.className = 'status-badge status-logged-out';
                loginBtn.textContent = 'üîê Admin Login';
                loginBtn.onclick = showLoginModal;
                document.body.classList.remove('admin-logged-in');
            }
        }

        function requireAuth() {
            if (!appData.settings.isAuthenticated) {
                showCustomAlert('üîê Admin authentication required!', 'Authorization Required', 'danger');
                showLoginModal();
                return false;
            }
            return true;
        }

        // ========== ADMIN CONTROLS MANAGEMENT ==========

        function updateAdminControls() {
            // Admin controls are now handled by CSS classes
            // The admin-only class is hidden by default and shown when logged in
        }

        // ========== TAB MANAGEMENT ==========

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'reports') updateReports();
            if (tabName === 'finance') updateFinance();
            if (tabName === 'logs') renderActivityLogs();
        }

        // ========== CORE APPLICATION FUNCTIONS ==========

        function initializePayments() {
            appData.members.forEach(member => {
                if (!appData.payments[member.id]) {
                    appData.payments[member.id] = {};
                }
                Object.keys(appData.years).forEach(year => {
                    if (!appData.payments[member.id][year]) {
                         // Initialize with null array for months if not present in Firestore
                        appData.payments[member.id][year] = Array(appData.years[year].months.length).fill(null);
                    }
                });
            });
        }

        // ========== YEAR MANAGEMENT ==========

        function renderYears() {
            const container = document.getElementById('yearsContainer');
            container.innerHTML = '';
            
            Object.keys(appData.years).sort().forEach(year => {
                const yearData = appData.years[year];
                const yearSection = document.createElement('div');
                yearSection.className = 'year-section';

                yearSection.innerHTML = `
                    <div class="year-header">
                        <div class="year-title">
                            ${year} - Rangdhanu Charity Fund
                            ${appData.settings.isAuthenticated ? 
                                `<button class="delete-btn admin-only" onclick="deleteYearConfirmation('${year}')">Delete Year</button>` : 
                                ''}
                        </div>
                        <div class="year-actions">
                            <button class="toggle-btn" onclick="toggleYear('${year}')">‚ñº</button>
                        </div>
                    </div>
                    <div id="year-${year}" class="collapsible">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr id="header-${year}"></tr>
                                </thead>
                                <tbody id="body-${year}"></tbody>
                                <tfoot>
                                    <tr id="total-${year}" style="font-weight: bold; background: #f8f9fa;"></tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(yearSection);
                renderYearTable(year);
            });
            
            updateDateRange();
        }

        function renderYearTable(year) {
            const headerRow = document.getElementById(`header-${year}`);
            const tableBody = document.getElementById(`body-${year}`);
            const totalRow = document.getElementById(`total-${year}`);
            const yearData = appData.years[year];

            headerRow.innerHTML = '<th>Member Name</th>';
            yearData.months.forEach((month, index) => {
                headerRow.innerHTML += `
                    <th>
                        <div class="month-header">
                            ${month}
                            ${appData.settings.isAuthenticated ? `<button class="delete-btn admin-only" onclick="deleteMonthConfirmation('${year}', ${index})">√ó</button>` : ''}
                        </div>
                    </th>`;
            });
            headerRow.innerHTML += '<th>Total</th>';

            tableBody.innerHTML = '';
            appData.members.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `<td><strong>${member.name}</strong></td>`;
                
                yearData.months.forEach((month, mIdx) => {
                    const payment = appData.payments[member.id]?.[year]?.[mIdx];
                    const cellClass = payment ? 'cell-green' : getCellClass(year, mIdx);
                    row.innerHTML += `
                        <td class="${cellClass}">
                            <input type="number" value="${payment || ''}" 
                                            onchange="updatePayment(${member.id}, '${year}', ${mIdx}, this.value)"
                                            placeholder="0" ${!appData.settings.isAuthenticated ? 'disabled' : ''}>
                        </td>`;
                });

                const total = (appData.payments[member.id]?.[year] || []).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
                row.innerHTML += `<td><strong><span class="taka-symbol">‡ß≥</span>${total.toFixed(2)}</strong></td>`;
                tableBody.appendChild(row);
            });

            totalRow.innerHTML = '<td>Monthly Total</td>';
            yearData.months.forEach((month, mIdx) => {
                const monthTotal = appData.members.reduce((sum, member) => 
                    sum + (parseFloat(appData.payments[member.id]?.[year]?.[mIdx]) || 0), 0);
                totalRow.innerHTML += `<td><span class="taka-symbol">‡ß≥</span>${monthTotal.toFixed(2)}</td>`;
            });

            const grandTotal = appData.members.reduce((sum, member) => 
                sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
            totalRow.innerHTML += `<td><span class="taka-symbol">‡ß≥</span>${grandTotal.toFixed(2)}</td>`;
        }

        function getCellClass(year, monthIndex) {
            const today = new Date();
            
            // Get the date ISO string and convert it back to a Date object
            const monthDateString = appData.years[year]?.monthDates[monthIndex];
            if (!monthDateString) return 'cell-white'; // Safety check for missing data
            
            const monthDate = new Date(monthDateString);

            // Correctly calculate deadline as the 10th of the current payment month
            const deadline = new Date(monthDate.getFullYear(), monthDate.getMonth(), 10);
            
            // Calculate the date for the start of the next month (to define the end of the current period)
            const nextMonthStart = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 1);
            
            // If the month hasn't started yet (e.g., today is Oct 15, and this cell is for Nov)
            if (today < monthDate) return 'cell-white';
            
            // If the current date is between the 1st and the 10th (inclusive)
            if (today >= monthDate && today <= deadline) return 'cell-yellow';
            
            // If the current date is after the 10th and before the next month starts (i.e., overdue)
            if (today > deadline && today < nextMonthStart) return 'cell-red';
            
            // If the current date is past the end of the month period, treat it as overdue if not paid.
            if (today >= nextMonthStart) return 'cell-red';

            return 'cell-white'; // Should not be reached for active months
        }

        function showAddYearModal() {
            if (!requireAuth()) return;
            document.getElementById('addYearModal').style.display = 'flex';
        }

        function hideAddYearModal() {
            document.getElementById('addYearModal').style.display = 'none';
        }

        async function confirmAddYear() {
            const year = document.getElementById('newYear').value;
            
            if (year && !appData.years[year]) {
                const newYearData = {
                    months: [],
                    monthDates: []
                };
                
                for (let month = 0; month < 12; month++) {
                    const date = new Date(year, month, 1);
                    const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    newYearData.months.push(monthName);
                    // Store as ISO string for Firebase compatibility
                    newYearData.monthDates.push(date.toISOString());
                }
                
                appData.years[year] = newYearData;

                appData.members.forEach(member => {
                    if (!appData.payments[member.id]) {
                        appData.payments[member.id] = {};
                    }
                    appData.payments[member.id][year] = Array(12).fill(null);
                    // Save new payment record to Firebase for each member
                    savePayment(member.id, year, appData.payments[member.id][year]);
                });
                
                // Save the new year data to Firebase
                await saveYear(year, appData.years[year]);
                
                renderYears();
                
                logActivity('added a new year', `Added year ${year} with 12 months`);
                
                hideAddYearModal();
                showCustomAlert(`‚úÖ Year ${year} added successfully with 12 months!`, 'Success', 'success');
            } else {
                showCustomAlert('‚ùå Year already exists or invalid year!', 'Error', 'danger');
            }
        }

        function showManageYearsModal() {
            if (!requireAuth()) return;
            
            const body = document.getElementById('manageYearsBody');
            body.innerHTML = '';
            
            Object.keys(appData.years).sort().forEach(year => {
                const yearData = appData.years[year];
                const totalCollection = appData.members.reduce((sum, member) => 
                    sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${year}</strong></td>
                    <td>${yearData.months.length} months</td>
                    <td><span class="taka-symbol">‡ß≥</span>${totalCollection.toFixed(2)}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteYearConfirmation('${year}')">Delete Year</button>
                    </td>
                `;
                body.appendChild(row);
            });
            
            document.getElementById('manageYearsModal').style.display = 'flex';
        }

        function hideManageYearsModal() {
            document.getElementById('manageYearsModal').style.display = 'none';
        }

        function deleteYearConfirmation(year) {
            if (!requireAuth()) return;
            
            if (Object.keys(appData.years).length <= 1) {
                showCustomAlert('‚ùå Cannot delete the only remaining year!', 'Error', 'danger');
                return;
            }

            const yearCollection = appData.members.reduce((sum, member) => 
                sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
            
            const message = yearCollection > 0
                ? `‚ö†Ô∏è Year ${year} has collected ‡ß≥${yearCollection.toFixed(2)}. Are you sure you want to delete it? This action cannot be undone!`
                : `Are you sure you want to delete year ${year}?`;

            showCustomConfirm(message, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    // Add to recycle bin before deleting
                    addToRecycleBin('year', {
                        year: year,
                        months: appData.years[year].months,
                        monthDates: appData.years[year].monthDates
                    }, appData.settings.currentAdmin);
                    
                    delete appData.years[year];
                    
                    appData.members.forEach(member => {
                        if (appData.payments[member.id]) {
                            delete appData.payments[member.id][year];
                            // Save member payment document to remove the year's data
                            savePayment(member.id, year, null); // Deleting the year data in payment doc
                        }
                    });
                    
                    // Delete the year document from Firebase
                    if (isOnline) {
                        try {
                            await db.collection('years').doc(year).delete();
                        } catch (error) {
                            console.error('Error deleting year from Firebase:', error);
                        }
                    }
                    
                    renderYears();
                    updateDashboard();
                    updateReports();
                    
                    logActivity('deleted a year', `Deleted year ${year} with total collection of ‡ß≥${yearCollection.toFixed(2)}`);
                    
                    showCustomAlert(`‚úÖ Year ${year} deleted successfully!`, 'Success', 'success');
                    
                    hideManageYearsModal();
                }
            });
        }

        function deleteMonthConfirmation(year, monthIndex) {
            if (!requireAuth()) return;
            const monthName = appData.years[year].months[monthIndex];
            
            showCustomConfirm(`Are you sure you want to delete ${monthName}?`, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    // Add to recycle bin before deleting
                    addToRecycleBin('month', {
                        year: year,
                        monthIndex: monthIndex,
                        monthName: monthName
                    }, appData.settings.currentAdmin);
                    
                    appData.years[year].months.splice(monthIndex, 1);
                    appData.years[year].monthDates.splice(monthIndex, 1);
                    
                    appData.members.forEach(member => {
                        if (appData.payments[member.id]?.[year]) {
                            appData.payments[member.id][year].splice(monthIndex, 1);
                            // Save individual member payment
                            savePayment(member.id, year, appData.payments[member.id][year]);
                        }
                    });
                    
                    // Update year data in Firebase
                    await saveYear(year, appData.years[year]);
                    
                    renderYears();
                    
                    logActivity('deleted a month', `Deleted ${monthName} from year ${year}`);
                    showCustomAlert(`‚úÖ Month ${monthName} deleted successfully!`, 'Success', 'success');
                }
            });
        }

        function toggleYear(year) {
            const element = document.getElementById(`year-${year}`);
            const button = element.previousElementSibling.querySelector('.toggle-btn');
            
            if (element.classList.contains('collapsed')) {
                element.classList.remove('collapsed');
                button.textContent = '‚ñº';
            } else {
                element.classList.add('collapsed');
                button.textContent = '‚ñ∂';
            }
        }

        function updateDateRange() {
            const years = Object.keys(appData.years).sort();
            if (years.length === 0) {
                document.getElementById('dateRange').textContent = "No years available";
                return;
            }
            
            const firstYear = years[0];
            const lastYear = years[years.length - 1];
            
            // Check if months exist before accessing the array
            const firstMonth = appData.years[firstYear].months[0] || firstYear;
            const lastMonth = appData.years[lastYear].months[appData.years[lastYear].months.length - 1] || lastYear;
            
            document.getElementById('dateRange').textContent = `${firstMonth} - ${lastMonth}`;
        }

        // ========== MEMBER MANAGEMENT ==========

        function showAddMemberModal() {
            if (!requireAuth()) return;
            document.getElementById('addMemberModal').style.display = 'flex';
        }

        function hideAddMemberModal() {
            document.getElementById('addMemberModal').style.display = 'none';
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberPhone').value = '';
            document.getElementById('newMemberEmail').value = '';
        }

        async function confirmAddMember() {
            const name = document.getElementById('newMemberName').value.trim();
            const phone = document.getElementById('newMemberPhone').value.trim();
            const email = document.getElementById('newMemberEmail').value.trim();
            
            if (name) {
                const newId = Math.max(...appData.members.map(m => m.id), 0) + 1;
                const newMember = {
                    id: newId,
                    name: name,
                    phone: phone || 'Not provided',
                    email: email || 'Not provided',
                    joinDate: new Date().toISOString().split('T')[0]
                };
                
                appData.members.push(newMember);
                
                appData.payments[newId] = {};
                Object.keys(appData.years).forEach(year => {
                    appData.payments[newId][year] = Array(appData.years[year].months.length).fill(null);
                });
                
                // Save to Firebase
                await saveMember(newMember);
                // Also save the new empty payment record
                Object.keys(appData.years).forEach(year => {
                    savePayment(newId, year, appData.payments[newId][year]);
                });
                
                renderYears();
                
                logActivity('added a new member', `Added member: ${name} (Phone: ${phone}, Email: ${email})`);
                
                hideAddMemberModal();
                showCustomAlert('‚úÖ Member added successfully!', 'Success', 'success');
            } else {
                showCustomAlert('‚ùå Please enter member name!', 'Input Error', 'warning');
            }
        }

        function showManageMembersModal() {
            if (!requireAuth()) return;
            
            const body = document.getElementById('manageMembersBody');
            body.innerHTML = '';
            
            appData.members.forEach(member => {
                const totalPaid = Object.keys(appData.years).reduce((sum, year) => 
                    sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" value="${member.name}" id="name-${member.id}" style="width: 100%;">
                    </td>
                    <td>
                        <input type="text" value="${member.phone}" id="phone-${member.id}" style="width: 100%;">
                    </td>
                    <td>
                        <input type="email" value="${member.email}" id="email-${member.id}" style="width: 100%;">
                    </td>
                    <td>${member.joinDate}</td>
                    <td><span class="taka-symbol">‡ß≥</span>${totalPaid.toFixed(2)}</td>
                    <td>
                        <button class="edit-btn" onclick="updateMember(${member.id})">üíæ Save</button>
                        <button class="delete-btn" onclick="deleteMemberConfirmation(${member.id})">üóëÔ∏è Delete</button>
                    </td>
                `;
                body.appendChild(row);
            });
            
            document.getElementById('manageMembersModal').style.display = 'flex';
        }

        function hideManageMembersModal() {
            document.getElementById('manageMembersModal').style.display = 'none';
        }

        async function updateMember(memberId) {
            const name = document.getElementById(`name-${memberId}`).value.trim();
            const phone = document.getElementById(`phone-${memberId}`).value.trim();
            const email = document.getElementById(`email-${memberId}`).value.trim();
            
            if (name) {
                const member = appData.members.find(m => m.id === memberId);
                if (member) {
                    const oldName = member.name;
                    member.name = name;
                    member.phone = phone;
                    member.email = email;
                    
                    // Save to Firebase
                    await saveMember(member);
                    
                    renderYears();
                    
                    logActivity('updated member information', `Updated member: ${oldName} -> ${name} (Phone: ${phone}, Email: ${email})`);
                    
                    showCustomAlert('‚úÖ Member updated successfully!', 'Success', 'success');
                }
            } else {
                showCustomAlert('‚ùå Member name cannot be empty!', 'Input Error', 'warning');
            }
        }

        function deleteMemberConfirmation(memberId) {
            if (!requireAuth()) return;
            const member = appData.members.find(m => m.id === memberId);
            if (!member) return;
            
            showCustomConfirm(`Are you sure you want to delete member ${member.name}? This will also delete all their payment records!`, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    // Add to recycle bin before deleting
                    addToRecycleBin('member', {
                        id: member.id,
                        name: member.name,
                        phone: member.phone,
                        email: member.email,
                        joinDate: member.joinDate,
                        payments: appData.payments[memberId] // Save payment records for potential restoration
                    }, appData.settings.currentAdmin);
                    
                    appData.members = appData.members.filter(m => m.id !== memberId);
                    delete appData.payments[memberId];
                    
                    // Delete from Firebase
                    if (isOnline) {
                        try {
                            await db.collection('members').doc(memberId.toString()).delete();
                            await db.collection('payments').doc(memberId.toString()).delete();
                        } catch (error) {
                            console.error('Error deleting member from Firebase:', error);
                        }
                    }
                    
                    renderYears();
                    
                    logActivity('deleted a member', `Deleted member: ${member.name}`);
                    
                    hideManageMembersModal();
                    showCustomAlert(`‚úÖ Member ${member.name} deleted successfully!`, 'Success', 'success');
                }
            });
        }

        // ========== PAYMENT MANAGEMENT ==========

        async function updatePayment(memberId, year, monthIndex, value) {
            if (!appData.settings.isAuthenticated) {
                showCustomAlert('üîê Admin access required to modify payments!', 'Authorization Required', 'danger');
                return;
            }
            
            if (!appData.payments[memberId]) {
                appData.payments[memberId] = {};
            }
            if (!appData.payments[memberId][year]) {
                appData.payments[memberId][year] = Array(appData.years[year].months.length).fill(null);
            }
            
            const oldValue = appData.payments[memberId][year][monthIndex];
            appData.payments[memberId][year][monthIndex] = value ? parseFloat(value) : null;
            
            const member = appData.members.find(m => m.id === memberId);
            const monthName = appData.years[year].months[monthIndex];
            
            // Save to Firebase
            await savePayment(memberId, year, appData.payments[memberId][year]);
            
            renderYearTable(year);
            updateDashboard();
            
            if (oldValue !== appData.payments[memberId][year][monthIndex]) {
                const action = appData.payments[memberId][year][monthIndex] ? 
                    `added payment for ${monthName}` : `removed payment for ${monthName}`;
                
                logActivity('updated payment', 
                    `${appData.settings.currentAdmin} ${action} for ${member.name} (Year: ${year}, Amount: ‡ß≥${value || 0})`);
            }
            
            // Reset inactivity timer on any admin action
            resetInactivityTimer();
        }

        // ========== DONATION MANAGEMENT ==========

        function showAddDonationModal() {
            if (!requireAuth()) return;
            document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('donorName').value = '';
            document.getElementById('donationAmount').value = '';
            document.getElementById('donationNote').value = '';
            document.getElementById('donationModal').style.display = 'flex';
        }

        function hideDonationModal() {
            document.getElementById('donationModal').style.display = 'none';
        }

        async function confirmAddDonation() {
            const date = document.getElementById('donationDate').value;
            const name = document.getElementById('donorName').value.trim();
            const amount = parseFloat(document.getElementById('donationAmount').value);
            const note = document.getElementById('donationNote').value.trim();
            
            if (!date || !name || !amount) {
                showCustomAlert('‚ùå Please enter Date, Donor Name, and Amount.', 'Input Error', 'warning');
                return;
            }

            const donation = { date, name, amount, note: note || '' };
            
            // Save to Firebase, which returns the new Document ID
            const newId = await saveDonation(donation);
            donation.id = newId; // Assign the new Firebase document ID to the local object

            appData.donations.push(donation);
            
            renderDonations();
            updateDashboard();
            updateFinance();
            
            logActivity('added donation', 
                `${appData.settings.currentAdmin} added donation from ${name} (Amount: ‡ß≥${amount}, Date: ${date})`);

            hideDonationModal();
            showCustomAlert('‚úÖ Donation successfully recorded!', 'Success', 'success');
            
            // Reset inactivity timer on any admin action
            resetInactivityTimer();
        }

        function renderDonations() {
            const donationsBody = document.getElementById('donationsBody');
            donationsBody.innerHTML = '';
            
            appData.donations.forEach((donation) => {
                const row = document.createElement('tr');
                // Use donation.id for delete confirmation
                row.innerHTML = `
                    <td>${donation.date}</td>
                    <td>${donation.name}</td>
                    <td><span class="taka-symbol">‡ß≥</span>${donation.amount.toFixed(2)}</td>
                    <td>${donation.note}</td>
                    <td class="admin-only">
                        <button class="delete-btn" onclick="deleteDonationConfirmation('${donation.id}')">Delete</button>
                    </td>
                `;
                donationsBody.appendChild(row);
            });

            const total = appData.donations.reduce((sum, d) => sum + d.amount, 0);
            document.getElementById('totalDonations').textContent = total.toFixed(2);
        }

        function deleteDonationConfirmation(donationId) {
            if (!requireAuth()) return;
            
            const indexToDelete = appData.donations.findIndex(d => d.id === donationId);
            const donation = appData.donations[indexToDelete];
            if (!donation) return;

            showCustomConfirm(`Are you sure you want to delete the donation from ${donation.name} for ‡ß≥${donation.amount.toFixed(2)}?`, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    // Add to recycle bin before deleting
                    addToRecycleBin('donation', donation, appData.settings.currentAdmin);
                    
                    const deletedDonation = appData.donations.splice(indexToDelete, 1)[0];
                    
                    // Delete from Firebase using the document ID
                    if (deletedDonation.id && isOnline) {
                        try {
                            await db.collection('donations').doc(deletedDonation.id).delete();
                        } catch (error) {
                            console.error('Error deleting donation from Firebase:', error);
                        }
                    }
                    
                    renderDonations();
                    updateDashboard();
                    updateFinance();
                    
                    logActivity('deleted donation', 
                        `${appData.settings.currentAdmin} deleted donation from ${deletedDonation.name} (Amount: ‡ß≥${deletedDonation.amount}, Date: ${deletedDonation.date})`);
                    
                    showCustomAlert('‚úÖ Donation deleted successfully!', 'Success', 'success');
                    
                    // Reset inactivity timer on any admin action
                    resetInactivityTimer();
                }
            });
        }

        // ========== EXPENSE MANAGEMENT ==========

        function showAddExpenseModal() {
            if (!requireAuth()) return;
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addExpenseModal').style.display = 'flex';
        }

        function hideAddExpenseModal() {
            document.getElementById('addExpenseModal').style.display = 'none';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDescription').value = '';
        }

        async function confirmAddExpense() {
            const date = document.getElementById('expenseDate').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();
            
            if (!date || !amount || !description) {
                showCustomAlert('‚ùå Please fill all required fields!', 'Input Error', 'warning');
                return;
            }
            
            const expense = {
                date: date,
                amount: amount,
                category: category,
                description: description,
                addedBy: appData.settings.currentAdmin,
                addedOn: new Date().toISOString()
            };
            
            // Save to Firebase, which returns the new Document ID
            const newId = await saveExpense(expense);
            expense.id = newId; // Assign the new Firebase document ID to the local object

            appData.expenses.push(expense);
            
            renderExpenses();
            updateFinance();
            
            logActivity('added expense', 
                `${appData.settings.currentAdmin} added expense (Amount: ‡ß≥${amount}, Category: ${category}, Description: ${description})`);
            
            hideAddExpenseModal();
            showCustomAlert('‚úÖ Expense added successfully!', 'Success', 'success');
            
            // Reset inactivity timer on any admin action
            resetInactivityTimer();
        }

        function renderExpenses() {
            const expensesBody = document.getElementById('expensesBody');
            expensesBody.innerHTML = '';
            
            appData.expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            appData.expenses.forEach((expense) => {
                const row = document.createElement('tr');
                // Use expense.id for delete confirmation
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td><span class="taka-symbol">‡ß≥</span>${expense.amount.toFixed(2)}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td class="admin-only">
                        <button class="delete-btn" onclick="deleteExpenseConfirmation('${expense.id}')">Delete</button>
                    </td>
                `;
                expensesBody.appendChild(row);
            });
        }

        function deleteExpenseConfirmation(expenseId) {
            if (!requireAuth()) return;
            
            const indexToDelete = appData.expenses.findIndex(e => e.id === expenseId);
            const expense = appData.expenses[indexToDelete];
            if (!expense) return;

            showCustomConfirm(`Are you sure you want to delete the expense of ‡ß≥${expense.amount.toFixed(2)} (${expense.category})?`, 'Confirm Deletion', 'danger', async (confirmed) => {
                if (confirmed) {
                    // Add to recycle bin before deleting
                    addToRecycleBin('expense', expense, appData.settings.currentAdmin);
                    
                    const deletedExpense = appData.expenses.splice(indexToDelete, 1)[0];
                    
                    // Delete from Firebase using the document ID
                    if (deletedExpense.id && isOnline) {
                        try {
                            await db.collection('expenses').doc(deletedExpense.id).delete();
                        } catch (error) {
                            console.error('Error deleting expense from Firebase:', error);
                        }
                    }
                    
                    renderExpenses();
                    updateFinance();
                    
                    logActivity('deleted expense', 
                        `${appData.settings.currentAdmin} deleted expense (Amount: ‡ß≥${expense.amount}, Category: ${expense.category}, Description: ${expense.description})`);
                    
                    showCustomAlert('‚úÖ Expense deleted successfully!', 'Success', 'success');
                    
                    // Reset inactivity timer on any admin action
                    resetInactivityTimer();
                }
            });
        }

        // ========== DASHBOARD FUNCTIONS ==========

        function updateDashboard() {
            const totalCollected = getTotalCollected();
            const totalDonations = getTotalDonations();
            
            const today = new Date();
            let currentMonthCollection = 0;
            let paidMembers = 0;
            let dueMembers = 0;

            // Iterate over all years and all months to find the current month
            Object.keys(appData.years).sort().forEach(year => {
                const yearData = appData.years[year];
                yearData.monthDates.forEach((monthDateString, index) => {
                    const monthDate = new Date(monthDateString);
                    // Determine the start of the next month
                    const nextMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 1);
                    
                    if (today >= monthDate && today < nextMonth) {
                        currentMonthCollection = appData.members.reduce((sum, member) => 
                            sum + (parseFloat(appData.payments[member.id]?.[year]?.[index]) || 0), 0);
                        
                        // Count paid and due members for the CURRENT month/year index
                        paidMembers = appData.members.filter(member => 
                            parseFloat(appData.payments[member.id]?.[year]?.[index]) > 0).length;
                        dueMembers = appData.members.length - paidMembers;
                    }
                });
            });

            document.getElementById('totalCollected').textContent = `‡ß≥${(totalCollected + totalDonations).toFixed(2)}`;
            document.getElementById('currentMonthCollection').textContent = `‡ß≥${currentMonthCollection.toFixed(2)}`;
            document.getElementById('paidCount').textContent = paidMembers;
            document.getElementById('dueCount').textContent = dueMembers;

            updateCharts();
        }

        function updateCharts() {
            const allMonths = [];
            const monthlyData = [];
            
            Object.keys(appData.years).sort().forEach(year => {
                appData.years[year].months.forEach((month, index) => {
                    allMonths.push(month);
                    const monthTotal = appData.members.reduce((sum, member) => 
                        sum + (parseFloat(appData.payments[member.id]?.[year]?.[index]) || 0), 0);
                    monthlyData.push(monthTotal);
                });
            });

            const contributorData = appData.members.map(member => ({
                name: member.name,
                total: Object.keys(appData.years).reduce((sum, year) => 
                    sum + (appData.payments[member.id]?.[year] || []).reduce((s, v) => s + (parseFloat(v) || 0), 0), 0)
            })).sort((a, b) => b.total - a.total).slice(0, 10);

            if (monthlyChart) monthlyChart.destroy();
            if (contributorsChart) contributorsChart.destroy();

            const ctx1 = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: allMonths,
                    datasets: [{
                        label: 'Monthly Collection (‡ß≥)',
                        data: monthlyData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‡ß≥' + value;
                                }
                            }
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('contributorsChart').getContext('2d');
            contributorsChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: contributorData.map(c => c.name),
                    datasets: [{
                        label: 'Total Contribution (‡ß≥)',
                        data: contributorData.map(c => c.total),
                        backgroundColor: '#764ba2'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‡ß≥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========== FINANCE FUNCTIONS ==========

        function updateFinance() {
            const totalIncome = getTotalCollected() + getTotalDonations();
            const totalExpenditure = getTotalExpenditure();
            const currentBalance = totalIncome - totalExpenditure;
            
            document.getElementById('totalIncome').textContent = `‡ß≥${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenditure').textContent = `‡ß≥${totalExpenditure.toFixed(2)}`;
            document.getElementById('currentBalance').textContent = `‡ß≥${currentBalance.toFixed(2)}`;
            
            updateFinanceChart();
        }

        function updateFinanceChart() {
            const incomeByMonth = {};
            const expenseByMonth = {};
            
            Object.keys(appData.years).sort().forEach(year => {
                appData.years[year].months.forEach(month => {
                    incomeByMonth[month] = 0;
                    expenseByMonth[month] = 0;
                });
            });
            
            Object.keys(appData.years).sort().forEach(year => {
                appData.years[year].months.forEach((month, index) => {
                    const monthIncome = appData.members.reduce((sum, member) => 
                        sum + (parseFloat(appData.payments[member.id]?.[year]?.[index]) || 0), 0);
                    incomeByMonth[month] += monthIncome;
                });
            });
            
            appData.expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                const expenseMonth = expenseDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                if (expenseByMonth[expenseMonth] !== undefined) {
                    expenseByMonth[expenseMonth] += expense.amount;
                }
            });
            
            const months = Object.keys(incomeByMonth);
            const incomeData = months.map(month => incomeByMonth[month]);
            const expenseData = months.map(month => expenseByMonth[month]);
            
            if (financeChart) financeChart.destroy();
            
            const ctx = document.getElementById('financeChart').getContext('2d');
            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Collection (‡ß≥)',
                            data: incomeData,
                            backgroundColor: '#28a745'
                        },
                        {
                            label: 'Expenditure (‡ß≥)',
                            data: expenseData,
                            backgroundColor: '#dc3545'
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‡ß≥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function getTotalExpenditure() {
            return appData.expenses.reduce((sum, expense) => sum + expense.amount, 0);
        }

        // ========== REPORTS FUNCTIONS ==========

        function updateReports() {
            const today = new Date();
            let currentPaidMembers = [];
            let currentDueMembers = [];

            Object.keys(appData.years).sort().forEach(year => {
                const yearData = appData.years[year];
                yearData.monthDates.forEach((monthDateString, index) => {
                    const monthDate = new Date(monthDateString);
                    const nextMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 1);

                    if (today >= monthDate && today < nextMonth) {
                        currentPaidMembers = appData.members.filter(member => 
                            parseFloat(appData.payments[member.id]?.[year]?.[index]) > 0);
                        currentDueMembers = appData.members.filter(member => 
                            !parseFloat(appData.payments[member.id]?.[year]?.[index]) > 0);
                    }
                });
            });

            document.getElementById('paidCountReport').textContent = currentPaidMembers.length;
            document.getElementById('dueCountReport').textContent = currentDueMembers.length;

            const paidList = document.getElementById('paidList');
            const dueList = document.getElementById('dueList');
            
            paidList.innerHTML = '';
            dueList.innerHTML = '';

            currentPaidMembers.forEach(member => {
                const div = document.createElement('div');
                div.className = 'member-item paid';
                div.textContent = member.name;
                paidList.appendChild(div);
            });

            currentDueMembers.forEach(member => {
                const div = document.createElement('div');
                div.className = 'member-item due';
                div.textContent = member.name;
                dueList.appendChild(div);
            });

            // Update the contribution summary with all members (no filter initially)
            updateReportsWithFilter(appData.members);
        }

        function toggleMemberList(type) {
            const section = document.getElementById(type + 'ListSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }

        // ========== ACTIVITY LOGS ==========

        function renderActivityLogs() {
            const logsContainer = document.getElementById('activityLogs');
            logsContainer.innerHTML = '';
            
            if (appData.activityLogs.length === 0) {
                logsContainer.innerHTML = '<div class="log-entry">No activity logs yet.</div>';
                return;
            }
            
            appData.activityLogs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timestamp = new Date(log.timestamp).toLocaleString();
                
                logEntry.innerHTML = `
                    <div>
                        <span class="log-timestamp">${timestamp}</span> - 
                        <span class="log-admin">${log.admin}</span> 
                        <span class="log-action">${log.action}</span>
                    </div>
                    <div class="log-details">${log.details}</div>
                `;
                
                logsContainer.appendChild(logEntry);
            });
        }

        // ========== EXPORT FUNCTIONALITY ==========

        function showExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
            
            const yearSelect = document.getElementById('exportYearSelect');
            yearSelect.innerHTML = '';
            Object.keys(appData.years).sort().forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            document.getElementById('exportData').addEventListener('change', function() {
                const yearGroup = document.getElementById('yearSelectionGroup');
                yearGroup.style.display = this.value === 'members' ? 'block' : 'none';
            });
        }

        function hideExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function exportData() {
            const format = document.getElementById('exportFormat').value;
            const dataType = document.getElementById('exportData').value;
            const selectedYear = document.getElementById('exportYearSelect').value;
            
            switch(format) {
                case 'excel':
                    exportToExcel(dataType, selectedYear);
                    break;
                case 'pdf':
                    exportToPDF(dataType, selectedYear);
                    break;
            }
            
            hideExportModal();
            // Don't log activity for public exports
            if (appData.settings.isAuthenticated) {
                logActivity('exported data', `Exported ${dataType} data as ${format.toUpperCase()}`);
            }
        }

        function exportToExcel(dataType, selectedYear) {
            try {
                const wb = XLSX.utils.book_new();
                let fileName = `Rangdhanu_Charity_Report_${new Date().toISOString().split('T')[0]}`;
                const members = appData.members;
                const payments = appData.payments;
                const years = appData.years;

                const addSummarySheet = () => {
                    const summaryData = [
                        ['Rangdhanu Charity Fund - Financial Summary'],
                        ['Generated on:', new Date().toLocaleString()],
                        ['App Version:', appData.appVersion],
                        [''],
                        ['KEY STATISTICS'],
                        ['Total Members:', members.length],
                        ['Total Member Collections (‡ß≥):', getTotalCollected().toFixed(2)],
                        ['Total Public Donations (‡ß≥):', getTotalDonations().toFixed(2)],
                        ['Total Collection (‡ß≥):', (getTotalCollected() + getTotalDonations()).toFixed(2)],
                        ['Total Expenditure (‡ß≥):', getTotalExpenditure().toFixed(2)],
                        ['Current Balance (‡ß≥):', (getTotalCollected() + getTotalDonations() - getTotalExpenditure()).toFixed(2)]
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, ws, "Financial Summary");
                };

                if (dataType === 'financial' || dataType === 'all') {
                    addSummarySheet();

                    const expenseData = [['Date', 'Amount (‡ß≥)', 'Category', 'Description', 'Added By', 'Added On']];
                    appData.expenses.forEach(expense => {
                        expenseData.push([
                            expense.date, 
                            expense.amount, 
                            expense.category, 
                            expense.description,
                            expense.addedBy,
                            new Date(expense.addedOn).toLocaleString()
                        ]);
                    });
                    const ws3 = XLSX.utils.aoa_to_sheet(expenseData);
                    XLSX.utils.book_append_sheet(wb, ws3, "Detailed Expenses");
                    fileName = 'Rangdhanu_Financial_Report';
                }

                if (dataType === 'members' || dataType === 'all') {
                    const paymentData = [];
                    const selectedYearRange = dataType === 'members' && selectedYear ? [selectedYear] : Object.keys(years).sort();
                    
                    const headers = ['Member Name', 'Phone', 'Email', 'Join Date'];
                    selectedYearRange.forEach(year => {
                        years[year].months.forEach(month => {
                            headers.push(`${year} - ${month} (‡ß≥)`);
                        });
                    });
                    headers.push('Total Contribution (‡ß≥)');
                    paymentData.push(headers);
                    
                    members.forEach(member => {
                        const row = [member.name, member.phone, member.email, member.joinDate];
                        let total = 0;
                        
                        selectedYearRange.forEach(year => {
                            years[year].months.forEach((month, mIdx) => {
                                const amount = payments[member.id]?.[year]?.[mIdx] || 0;
                                row.push(amount);
                                total += parseFloat(amount) || 0;
                            });
                        });
                        row.push(total.toFixed(2));
                        paymentData.push(row);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(paymentData);
                    XLSX.utils.book_append_sheet(wb, ws, `Member Payments ${selectedYear || 'All'}`);
                    
                    if (dataType === 'members') {
                        addSummarySheet();
                        fileName = `Rangdhanu_Members_Sheet_${selectedYear || 'All'}`;
                    }
                }

                if (dataType === 'donations' || dataType === 'all') {
                    const donationData = [['Date', 'Donor Name', 'Amount (‡ß≥)', 'Note']];
                    appData.donations.forEach(donation => {
                        donationData.push([donation.date, donation.name, donation.amount.toFixed(2), donation.note]);
                    });
                    
                    const ws2 = XLSX.utils.aoa_to_sheet(donationData);
                    XLSX.utils.book_append_sheet(wb, ws2, "Public Donations");
                    
                    if (dataType === 'donations') {
                        addSummarySheet();
                        fileName = 'Rangdhanu_Donations_Report';
                    }
                }

                if (dataType === 'expenses') {
                    const expenseData = [['Date', 'Amount (‡ß≥)', 'Category', 'Description', 'Added By', 'Added On']];
                    appData.expenses.forEach(expense => {
                        expenseData.push([
                            expense.date, 
                            expense.amount.toFixed(2), 
                            expense.category, 
                            expense.description,
                            expense.addedBy,
                            new Date(expense.addedOn).toLocaleString()
                        ]);
                    });
                    const ws3 = XLSX.utils.aoa_to_sheet(expenseData);
                    XLSX.utils.book_append_sheet(wb, ws3, "Detailed Expenses");
                    addSummarySheet();
                    fileName = 'Rangdhanu_Expenses_Report';
                }
                
                if (dataType === 'logs' || dataType === 'all') {
                    const logData = [['Timestamp', 'Admin', 'Action', 'Details']];
                    appData.activityLogs.forEach(log => {
                        logData.push([
                            new Date(log.timestamp).toLocaleString(),
                            log.admin,
                            log.action,
                            log.details
                        ]);
                    });
                    
                    const ws4 = XLSX.utils.aoa_to_sheet(logData);
                    XLSX.utils.book_append_sheet(wb, ws4, "Activity Logs");
                    if (dataType === 'logs') {
                        fileName = 'Rangdhanu_Activity_Logs';
                    }
                }

                XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`);
                showCustomAlert('‚úÖ Excel file exported successfully with comprehensive sheets!', 'Export Success', 'success');
            } catch (error) {
                showCustomAlert('‚ùå Error exporting Excel file: ' + error.message, 'Export Error', 'danger');
            }
        }

        function exportToPDF(dataType, selectedYear) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const title = 'Rangdhanu Charity Fund - Financial Report';
                doc.setFontSize(20);
                doc.setTextColor(40, 40, 40);
                doc.text(title, 105, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated on: ${new Date().toLocaleDateString()} | Data: ${document.getElementById('exportData').options[document.getElementById('exportData').selectedIndex].text}`, 105, 22, { align: 'center' });
                
                let yPosition = 35;
                const margin = 14;
                const primaryColor = [102, 126, 234]; // #667eea

                const addSectionTitle = (titleText) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.setFontSize(16);
                    doc.setTextColor(40, 40, 40);
                    doc.text(titleText, margin, yPosition);
                    yPosition += 8;
                };

                const addSummaryTable = () => {
                    const totalIncome = getTotalCollected() + getTotalDonations();
                    const totalExpenditure = getTotalExpenditure();
                    const currentBalance = totalIncome - totalExpenditure;

                    addSectionTitle('I. Overall Financial Summary');

                    const summaryData = [
                        ['Total Members', appData.members.length.toString()],
                        ['Total Member Collections', `‡ß≥${getTotalCollected().toFixed(2)}`],
                        ['Total Public Donations', `‡ß≥${getTotalDonations().toFixed(2)}`],
                        ['Total Collection (Collection + Donations)', `‡ß≥${totalIncome.toFixed(2)}`],
                        ['Total Expenditure', `‡ß≥${totalExpenditure.toFixed(2)}`],
                        ['Current Balance', `‡ß≥${currentBalance.toFixed(2)}`]
                    ];

                    doc.autoTable({
                        startY: yPosition,
                        head: [['Metric', 'Value']],
                        body: summaryData,
                        theme: 'grid',
                        headStyles: { fillColor: primaryColor, fontSize: 10 },
                        styles: { fontSize: 10, cellPadding: 2 },
                        columnStyles: { 0: { fontStyle: 'bold' } },
                        margin: { left: margin, right: margin }
                    });
                    yPosition = doc.lastAutoTable.finalY + 15;
                };

                addSummaryTable();

                if (dataType === 'members' || dataType === 'all') {
                    addSectionTitle(`II. Detailed Member Payments - ${selectedYear || 'All Time'}`);
                    
                    const memberRows = [];
                    const allMemberHeaders = ['Member', 'Total ‡ß≥', 'Paid Months', 'Due Months'];
                    
                    appData.members.forEach(member => {
                        let total = 0;
                        let paidMonths = 0;
                        let totalMonths = 0;
                        
                        Object.keys(appData.years).sort().forEach(year => {
                            if (dataType === 'members' && selectedYear && year !== selectedYear) return;
                            const yearPayments = appData.payments[member.id]?.[year] || [];
                            paidMonths += yearPayments.filter(val => val !== null && parseFloat(val) > 0).length;
                            totalMonths += yearPayments.length;
                            total += yearPayments.reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
                        });
                        
                        memberRows.push([
                            member.name, 
                            `‡ß≥${total.toFixed(2)}`, 
                            paidMonths, 
                            (totalMonths - paidMonths)
                        ]);
                    });
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: [allMemberHeaders],
                        body: memberRows,
                        theme: 'grid',
                        headStyles: { fillColor: primaryColor, fontSize: 10 },
                        styles: { fontSize: 9, cellPadding: 2 },
                        columnStyles: { 1: { fontStyle: 'bold' } },
                        margin: { left: margin, right: margin }
                    });
                    yPosition = doc.lastAutoTable.finalY + 15;
                }

                if (dataType === 'donations' || dataType === 'all' || dataType === 'financial') {
                    addSectionTitle('III. Public Donations Records');
                    
                    const donationHeaders = ['Date', 'Donor Name', 'Amount (‡ß≥)', 'Note'];
                    const donationRows = appData.donations.map(d => [
                        d.date, 
                        d.name, 
                        `‡ß≥${d.amount.toFixed(2)}`, 
                        d.note.substring(0, 50) + (d.note.length > 50 ? '...' : '')
                    ]);
                    
                    if (donationRows.length > 0) {
                        doc.autoTable({
                            startY: yPosition,
                            head: [donationHeaders],
                            body: donationRows,
                            theme: 'grid',
                            headStyles: { fillColor: primaryColor, fontSize: 10 },
                            styles: { fontSize: 9, cellPadding: 2 },
                            margin: { left: margin, right: margin }
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('No public donation records found.', margin, yPosition + 5);
                        doc.lastAutoTable = { finalY: yPosition + 10 };
                    }
                    yPosition = doc.lastAutoTable.finalY + 15;
                }
                
                if (dataType === 'expenses' || dataType === 'all' || dataType === 'financial') {
                    addSectionTitle('IV. Detailed Expenditure Records');

                    const expenseHeaders = ['Date', 'Amount (‡ß≥)', 'Category', 'Description'];
                    const expenseRows = appData.expenses.map(e => [
                        e.date, 
                        `‡ß≥${e.amount.toFixed(2)}`, 
                        e.category, 
                        e.description.substring(0, 70) + (e.description.length > 70 ? '...' : '')
                    ]);
                    
                    if (expenseRows.length > 0) {
                        doc.autoTable({
                            startY: yPosition,
                            head: [expenseHeaders],
                            body: expenseRows,
                            theme: 'grid',
                            headStyles: { fillColor: primaryColor, fontSize: 10 },
                            styles: { fontSize: 9, cellPadding: 2 },
                            margin: { left: margin, right: margin }
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('No expenditure records found.', margin, yPosition + 5);
                        doc.lastAutoTable = { finalY: yPosition + 10 };
                    }
                    yPosition = doc.lastAutoTable.finalY + 15;
                }

                if (dataType === 'logs' || dataType === 'all') {
                    addSectionTitle('V. Admin Activity Logs');
                    
                    const logHeaders = ['Timestamp', 'Admin', 'Action', 'Details'];
                    const logRows = appData.activityLogs.map(log => [
                        new Date(log.timestamp).toLocaleString(),
                        log.admin,
                        log.action,
                        log.details.substring(0, 80) + (log.details.length > 80 ? '...' : '')
                    ]);
                    
                    if (logRows.length > 0) {
                        doc.autoTable({
                            startY: yPosition,
                            head: [logHeaders],
                            body: logRows.slice(0, 50),
                            theme: 'grid',
                            headStyles: { fillColor: primaryColor, fontSize: 10 },
                            styles: { fontSize: 8, cellPadding: 1 },
                            margin: { left: margin, right: margin }
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('No activity logs found.', margin, yPosition + 5);
                    }
                }
                
                doc.save(`Rangdhanu_Charity_Fund_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                showCustomAlert('‚úÖ PDF report exported successfully with comprehensive details!', 'Export Success', 'success');
            } catch (error) {
                showCustomAlert('‚ùå Error exporting PDF: ' + error.message, 'Export Error', 'danger');
            }
        }

        // ========== SYSTEM MANAGEMENT ==========

        function showManageModal() {
            if (!requireAuth()) return;
            document.getElementById('manageModal').style.display = 'flex';
        }

        function hideManageModal() {
            document.getElementById('manageModal').style.display = 'none';
        }

        function showBackupModal() {
            if (!requireAuth()) return;
            document.getElementById('backupModal').style.display = 'flex';
        }

        function hideBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        function showRestoreModal() {
            if (!requireAuth()) return;
            document.getElementById('restoreModal').style.display = 'flex';
            loadBackups();
        }

        function hideRestoreModal() {
            document.getElementById('restoreModal').style.display = 'none';
        }

        async function createBackup() {
            try {
                showLoading('Creating backup...');
                
                // Prepare serializable data for backup
                const serializableAppData = {
                    years: appData.years,
                    members: appData.members,
                    payments: appData.payments,
                    donations: appData.donations,
                    expenses: appData.expenses,
                    settings: appData.settings
                };

                const backupData = {
                    timestamp: new Date().toISOString(),
                    createdBy: appData.settings.currentAdmin,
                    data: serializableAppData
                };
                
                await db.collection('backups').add(backupData);
                
                hideBackupModal();
                hideLoading();
                showCustomAlert('‚úÖ Backup created successfully!', 'Backup Success', 'success');
                logActivity('created backup', `Backup created by ${appData.settings.currentAdmin}`);
            } catch (error) {
                hideLoading();
                showCustomAlert('‚ùå Error creating backup: ' + error.message, 'Backup Error', 'danger');
            }
        }

        async function loadBackups() {
            try {
                const backupSelect = document.getElementById('backupSelect');
                backupSelect.innerHTML = '<option value="">Loading backups...</option>';
                
                const backupsSnapshot = await db.collection('backups')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                backupSelect.innerHTML = '';
                
                if (backupsSnapshot.empty) {
                    backupSelect.innerHTML = '<option value="">No backups found</option>';
                    return;
                }
                
                backupsSnapshot.forEach(doc => {
                    const backup = doc.data();
                    const date = new Date(backup.timestamp).toLocaleString();
                    backupSelect.innerHTML += `<option value="${doc.id}">${date} (by ${backup.createdBy})</option>`;
                });
            } catch (error) {
                console.error('Error loading backups:', error);
                document.getElementById('backupSelect').innerHTML = '<option value="">Error loading backups</option>';
            }
        }

        async function restoreBackup() {
            const backupId = document.getElementById('backupSelect').value;
            if (!backupId) {
                showCustomAlert('‚ùå Please select a backup to restore!', 'Restore Error', 'warning');
                return;
            }
            
            showCustomConfirm('‚ö†Ô∏è This will overwrite all current data. Are you sure you want to restore this backup?', 'Confirm Restore', 'danger', async (confirmed) => {
                if (confirmed) {
                    try {
                        showLoading('Restoring backup...');
                        
                        const backupDoc = await db.collection('backups').doc(backupId).get();
                        if (!backupDoc.exists) {
                            throw new Error('Backup not found');
                        }
                        
                        const backupData = backupDoc.data().data;
                        
                        // Restore data locally
                        appData.years = backupData.years;
                        appData.members = backupData.members;
                        appData.payments = backupData.payments;
                        appData.donations = backupData.donations;
                        appData.expenses = backupData.expenses;
                        appData.settings = { ...appData.settings, ...backupData.settings };
                        
                        // Overwrite main collections with restored data using batch writes
                        const batch = db.batch();

                        // Helper function to delete all documents in a collection (necessary for a full restore)
                        const deleteCollection = async (collectionPath, batch) => {
                            const snapshot = await db.collection(collectionPath).get();
                            snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        };

                        // 1. Members
                        await deleteCollection('members', batch);
                        backupData.members.forEach(member => {
                            batch.set(db.collection('members').doc(member.id.toString()), member);
                        });

                        // 2. Payments
                        await deleteCollection('payments', batch);
                        Object.keys(backupData.payments).forEach(memberId => {
                             // Note: Setting the entire object for the memberId document
                            batch.set(db.collection('payments').doc(memberId), backupData.payments[memberId]);
                        });

                        // 3. Years
                        await deleteCollection('years', batch);
                        Object.keys(backupData.years).forEach(year => {
                            batch.set(db.collection('years').doc(year), backupData.years[year]);
                        });

                        // 4. Donations
                        await deleteCollection('donations', batch);
                        backupData.donations.forEach(donation => {
                            // Ensure donation has an ID for setting, or use a new one
                            const docRef = donation.id ? db.collection('donations').doc(donation.id) : db.collection('donations').doc();
                            batch.set(docRef, donation);
                        });

                        // 5. Expenses
                        await deleteCollection('expenses', batch);
                        backupData.expenses.forEach(expense => {
                            const docRef = expense.id ? db.collection('expenses').doc(expense.id) : db.collection('expenses').doc();
                            batch.set(docRef, expense);
                        });

                        // 6. Settings (Merge to keep admin passwords safe if not in backup)
                        batch.set(db.collection('settings').doc('appSettings'), backupData.settings, { merge: true });
                        
                        // Commit the entire batch
                        await batch.commit();

                        // Re-render everything
                        initializePayments(); // Must be called before renderYears/etc.
                        renderYears();
                        renderDonations();
                        renderExpenses();
                        updateDashboard();
                        updateReports();
                        updateFinance();
                        renderActivityLogs();
                        
                        hideRestoreModal();
                        hideLoading();
                        showCustomAlert('‚úÖ Backup restored successfully!', 'Restore Success', 'success');
                        logActivity('restored backup', `Backup restored by ${appData.settings.currentAdmin}`);
                    } catch (error) {
                        hideLoading();
                        showCustomAlert('‚ùå Error restoring backup: ' + error.message, 'Restore Error', 'danger');
                    }
                }
            });
        }

        // ========== UTILITY FUNCTIONS ==========

        function getTotalCollected() {
            let total = 0;
            appData.members.forEach(member => {
                Object.keys(appData.years).forEach(year => {
                    total += (appData.payments[member.id]?.[year] || []).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
                });
            });
            return total;
        }

        function getTotalDonations() {
            return appData.donations.reduce((sum, d) => sum + d.amount, 0);
        }

        // ========== INITIALIZATION ==========

        async function initializeApp() {
            // Set up network listeners
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // Set up activity listeners for auto-logout
            setupActivityListeners();
            
            // Initialize Firebase and trigger all rendering AFTER data is loaded
            await initializeFirebase();
        }

        // Initialize the application
        initializeApp();

        // Remove the auto-save interval that saves every 30 seconds
        // Data now saves only when admin makes changes
    </script>
</body>
</html>
